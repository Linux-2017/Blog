{"title":"keepalived实现lvs-nat","slug":"lvs-nat-1","date":"2017-05-13T07:37:08.000Z","updated":"2017-11-19T13:15:37.000Z","comments":true,"excerpt":"","content":"<h3 id=\"keepalived实现lvs-nat\"><a href=\"#keepalived实现lvs-nat\" class=\"headerlink\" title=\"keepalived实现lvs-nat\"></a>keepalived实现lvs-nat</h3><p><strong>实验拓扑</strong></p>\n<p><img src=\"http://omsab2via.bkt.clouddn.com/lvs-nat.png\" alt=\"lvs-nat\"></p>\n<p><strong>配置</strong></p>\n<ul>\n<li><h5 id=\"配置前提\"><a href=\"#配置前提\" class=\"headerlink\" title=\"配置前提\"></a>配置前提</h5><ul>\n<li>各节点时间必须同步(ntp,chrony)</li>\n<li>iptables、selinux</li>\n<li>各节点之间可通过主机名实现互相通信(对ka并非必须)，一般用hosts</li>\n<li>各节点之间的root用户可以基于密匙认证完成互相通信；(非必须)</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><pre><code>iptables -F\nsetenforce 0\nyum install httpd php -y\necho 119 &gt; /var/www/html/1.html\n120\necho 120 &gt; /var/www/html/1.html\n</code></pre></li>\n<li><p>Director 1</p>\n<pre><code>iptables -F\nsetenforce 0\necho 1 &gt; /proc/sys/net/ipv4/ip_forward\nyum -y install keepalived\n#配置文件\n! Configuration File for keepalived\nglobal_defs {\n   notification_email {\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 192.168.200.1\n   smtp_connect_timeout 30\n   router_id dr1\n   vrrp_mcast_group4 224.0.0.50  广播地址\n}\nvrrp_instance mvr {\n    state MASTER #指定Keepalived的角色，MASTER为主服务器，BACKUP为备用服务器\n    interface ens33\n    virtual_router_id 50  #虚拟路由标识(1-255)，在一个VRRP实例中主备服务器ID必须一样\n    priority 100  #优先级\n    advert_int 1  #设置主备之间同步检查时间间隔，单位秒\n    authentication { #认证，以一个VRRP实例中主备服务器pass必须一致\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        172.18.50.100/16 dev ens33\n    }\n}\nvrrp_instance mvr1  {\n    state MASTER\n    interface ens38\n    virtual_router_id 51\n    priority 100\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1a111\n    }\n    virtual_ipaddress {\n        192.168.50.100/24 dev ens38\n    }\n}\nvirtual_server 172.18.50.100 80 { #设置虚拟服务器\n    delay_loop 6     #服务轮询的时间间隔\n    lb_algo rr          # rr|wrr|lc|wlc|lblc|sh|dh：定义调度方法\n    lb_kind NAT         # NAT|DR|TUN：集群的类型\n    nat_mask 255.255.0.0\n    persistence_timeout 0 #持久时间时长 单位为s\n    protocol TCP\n\n    real_server 192.168.50.119 80 {\n        weight 1\n        HTTP_GET {   #设置检测方式\n            url {\n              path /1.html\n              status_code 200 #设定返回状态码为200表示Realserver存活\n            } \n            connect_timeout 3 #设置响应超时时间\n            nb_get_retry 3      #设置超时重试次数\n            delay_before_retry 3     #设置超时重试间隔\n        }   \n}\n    real_server 192.168.50.120 80 {\n        weight 1\n        HTTP_GET {\n            url {\n              path /1.html\n              status_code 200\n            } \n            connect_timeout 3\n            nb_get_retry 3\n            delay_before_retry 3\n}\n}\n}\n</code></pre></li>\n<li><p>Director 2</p>\n<pre><code>! Configuration File for keepalived\nglobal_defs {\n   notification_email {\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 192.168.200.1\n   smtp_connect_timeout 30\n   router_id dr2\n   vrrp_mcast_group4 224.0.0.50\n}\nvrrp_instance mvr {\n    state BACKUP\n    interface ens33\n    virtual_router_id 50\n    priority 98\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n        172.18.50.100/16 dev ens33\n    }\n    notify_master &quot;/root/keepalived.sh master&quot;\n    notify_backup &quot;/root/keepalived.sh backup&quot;\n    notify_fault &quot;/root/keepalived.sh fault&quot;\n}\nvrrp_instance mvr1 {\n    state BACKUP\n    interface ens38\n    virtual_router_id 51\n    priority 98\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1a111\n    }\n    virtual_ipaddress {\n        192.168.50.100/24 dev ens38\n    }\n    notify_master &quot;/root/keepalived.sh master&quot;\n        notify_backup &quot;/root/keepalived.sh backup&quot;\n    notify_fault &quot;/root/keepalived.sh fault&quot;\n\n}\nvirtual_server 172.18.50.100 80 {\n    delay_loop 6\n    lb_algo rr\n    lb_kind NAT\n    nat_mask 255.255.0.0\n    persistence_timeout 0\n    protocol TCP\n\n    real_server 192.168.50.119 80 {\n        weight 1\n        HTTP_GET {\n            url {\n              path /1.html\n              status_code 200\n            } \n            connect_timeout 3\n            nb_get_retry 3\n            delay_before_retry 3\n        }\n}\n    real_server 192.168.50.120 80 {\n        weight 1\n        HTTP_GET {\n            url {\n              path /1.html\n              status_code 200\n            } \n            connect_timeout 3\n            nb_get_retry 3\n            delay_before_retry 3\n        }\n}\n}\n</code></pre><p>​</p>\n</li>\n</ul>\n","categories":[],"tags":[{"name":"keepalived","path":"api/tags/keepalived.json"},{"name":"lvs","path":"api/tags/lvs.json"}]}