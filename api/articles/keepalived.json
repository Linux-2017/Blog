{"title":"keepalived双主模型","slug":"keepalived","date":"2017-05-15T13:24:00.000Z","updated":"2017-11-19T13:15:37.000Z","comments":true,"excerpt":"","content":"<h4 id=\"Keepalived\"><a href=\"#Keepalived\" class=\"headerlink\" title=\"Keepalived\"></a><strong>Keepalived</strong></h4><ul>\n<li>DR1</li>\n</ul>\n<pre><code>[root@71 keepalived]# cat  keepalived.conf \n! Configuration File for keepalived\n\nglobal_defs {\n   notification_email {\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 192.168.200.1\n   smtp_connect_timeout 30\n   router_id LVS_DEVEL\n   vrrp_mcast_group4 224.0.0.50\n}\nvrrp_instance ip1 {\n    state MASTER\n    interface enp0s3\n    virtual_router_id 50\n    priority 100\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n         172.18.50.100/16 dev enp0s3\n    }\n}\nvrrp_instance ip2 {\n    state BACKUP\n    interface enp0s3\n    virtual_router_id 51\n    priority 80\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 22222\n    }\n    virtual_ipaddress {\n         172.18.50.200/16 dev enp0s3\n    }\n}\n</code></pre><ul>\n<li>DR2</li>\n</ul>\n<pre><code>[root@72 keepalived]# cat keepalived.conf \n! Configuration File for keepalived\n\nglobal_defs {\n   notification_email {\n     acassen@firewall.loc\n     failover@firewall.loc\n     sysadmin@firewall.loc\n   }\n   notification_email_from Alexandre.Cassen@firewall.loc\n   smtp_server 192.168.200.1\n   smtp_connect_timeout 30\n   router_id LVS_DEVEL\n   vrrp_mcast_group4 224.0.0.50\n}\nvrrp_instance ip1 {\n    state BACKUP\n    interface enp0s3\n    virtual_router_id 50\n    priority 90\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    virtual_ipaddress {\n         172.18.50.100/16 dev enp0s3\n    }\n}\nvrrp_instance ip2 {\n    state MASTER\n    interface enp0s3\n    virtual_router_id 51\n    priority 90\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 22222\n    }\n    virtual_ipaddress {\n         172.18.50.200/16 dev enp0s3\n    }\n}\n</code></pre><ul>\n<li>示例通知脚本：</li>\n</ul>\n<pre><code>#!/bin/bash\n#\ncontact=&#39;root@localhost&#39;\n\nnotify() {\n    mailsubject=&quot;$(hostname) to be $1, vip floating&quot;\n    mailbody=&quot;$(date +&#39;%F %T&#39;): vrrp transition, $(hostname) changed to be $1&quot;\n    echo &quot;$mailbody&quot; | mail -s &quot;$mailsubject&quot; $contact\n                }\n\ncase $1 in\nmaster)\n    notify master\n    ;;\nbackup)\n    notify backup\n    ;;\nfault)\n    notify fault\n    ;;\n*)\n    echo &quot;Usage: $(basename $0) {master|backup|fault}&quot;\n    exit 1\n    ;;\nesac\n</code></pre><ul>\n<li>调用方法</li>\n</ul>\n<pre><code>notify_master &quot;/etc/keepalived/notify.sh master&quot;\nnotify_backup &quot;/etc/keepalived/notify.sh backup&quot;\nnotify_fault &quot;/etc/keepalived/notify.sh fault&quot;\n</code></pre><ul>\n<li>高可用ipvs配置示例</li>\n</ul>\n<pre><code>virtual_server 172.18.50.100 {\n    delay_loop 3\n    lb_algo rr\n    lb_kind DR\n    protocol TCP\n\n    sorry_server 127.0.0.1 80\n\n    real_server 10.1.0.69 80 {\n        weight 1\n        HTTP_GET {\n        url {\n            path /\n            status_code 200\n        }\n        connect_timeout 1\n        nb_get_retry 3\n        delay_before_retry 1\n        }\n    }\n    real_server 10.1.0.71 80 {\n        weight 1\n        HTTP_GET {\n        url {\n            path /\n            status_code 200\n        }\n        connect_timeout 1\n        nb_get_retry 3\n        delay_before_retry 1\n        }\n    }\n}\n</code></pre><ul>\n<li>参数详解</li>\n</ul>\n<pre><code>delay_loop &lt;INT&gt;：服务轮询的时间间隔；\nlb_algo rr|wrr|lc|wlc|lblc|sh|dh：定义调度方法；\nlb_kind NAT|DR|TUN：集群的类型；\npersistence_timeout &lt;INT&gt;：持久连接时长；\nprotocol TCP：服务协议，仅支持TCP；\nsorry_server &lt;IPADDR&gt; &lt;PORT&gt;：备用服务器地址；\nreal_server &lt;IPADDR&gt; &lt;PORT&gt;\n{\n     weight &lt;INT&gt;\n     notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;\n     notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;\n     HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK { ... }：定义当前主机的健康状态检测方法；\n}\nHTTP_GET|SSL_GET：应用层检测\n\nHTTP_GET|SSL_GET {\n    url {\n        path &lt;URL_PATH&gt;：定义要监控的URL；\n        status_code &lt;INT&gt;：判断上述检测机制为健康状态的响应码；\n        digest &lt;STRING&gt;：判断上述检测机制为健康状态的响应的内容的校验码；\n    }\n    nb_get_retry &lt;INT&gt;：重试次数；\n    delay_before_retry &lt;INT&gt;：重试之前的延迟时长；\n    connect_ip &lt;IP ADDRESS&gt;：向当前RS的哪个IP地址发起健康状态检测请求\n    connect_port &lt;PORT&gt;：向当前RS的哪个PORT发起健康状态检测请求\n    bindto &lt;IP ADDRESS&gt;：发出健康状态检测请求时使用的源地址；\n    bind_port &lt;PORT&gt;：发出健康状态检测请求时使用的源端口；\n    connect_timeout &lt;INTEGER&gt;：连接请求的超时时长；\n}\n TCP_CHECK {\n    connect_ip &lt;IP ADDRESS&gt;：向当前RS的哪个IP地址发起健康状态检测请求\n    connect_port &lt;PORT&gt;：向当前RS的哪个PORT发起健康状态检测请求\n    bindto &lt;IP ADDRESS&gt;：发出健康状态检测请求时使用的源地址；\n    bind_port &lt;PORT&gt;：发出健康状态检测请求时使用的源端口；\n    connect_timeout &lt;INTEGER&gt;：连接请求的超时时长；\n}\n</code></pre>","categories":[{"name":"Keepalived","path":"api/categories/Keepalived.json"}],"tags":[{"name":"keepalived","path":"api/tags/keepalived.json"},{"name":"负载均衡","path":"api/tags/负载均衡.json"}]}