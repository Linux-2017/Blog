{"title":"Mariadb半同步复制及复制过滤器","slug":"Mariadb半同步复制及复制过滤器","date":"2017-06-12T13:28:08.000Z","updated":"2017-11-19T13:15:37.000Z","comments":true,"excerpt":"","content":"<h2 id=\"Mariadb半同步复制及复制过滤器\"><a href=\"#Mariadb半同步复制及复制过滤器\" class=\"headerlink\" title=\"Mariadb半同步复制及复制过滤器\"></a>Mariadb半同步复制及复制过滤器</h2><p>依赖的插件<br>/usr/lib64/mysql/plugin下</p>\n<blockquote>\n<p>semisync_master.so<br>semisync_slave.so</p>\n</blockquote>\n<h4 id=\"MASTER-172-18-50-72\"><a href=\"#MASTER-172-18-50-72\" class=\"headerlink\" title=\"MASTER(172.18.50.72)\"></a>MASTER(172.18.50.72)</h4><p>/etc/my.cnf.d/server.cnf配置</p>\n<pre><code>innodb_file_per_table=ON\nskip_name_resolve=ON\nlog_bin=mysql-bin\nserver_id=1\n</code></pre><p>授权slave服务器</p>\n<pre><code>GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO test@&#39;172.18.50.73&#39; IDENTIFIED BY &#39;test123&#39;;\n</code></pre><p>查看二进制文件</p>\n<pre><code>MariaDB [(none)]&gt; show master status;\n+------------------+----------+--------------+------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n+------------------+----------+--------------+------------------+\n| mysql-bin.000003 |      493 |              |                  |\n+------------------+----------+--------------+------------------+\n1 row in set (0.00 sec)\n</code></pre><p>安装插件</p>\n<pre><code>MariaDB [(none)]&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME &#39;semisync_master.so&#39;;\n</code></pre><p>查看是否安装成功</p>\n<pre><code>MariaDB [(none)]&gt; SHOW PLUGINS;\nrpl_semi_sync_master           | ACTIVE   | REPLICATION        | semisync_master.so | GPL\n</code></pre><p>开启rpl_semi_sync_master_enabled</p>\n<pre><code>SHOW VARIABLES LIKE &#39;%semi%&#39;;\nSET @@GLOBAL.rpl_semi_sync_master_enabled=ON\n</code></pre><h4 id=\"SLAVE-172-18-50-73\"><a href=\"#SLAVE-172-18-50-73\" class=\"headerlink\" title=\"SLAVE(172.18.50.73)\"></a>SLAVE(172.18.50.73)</h4><p>/etc/my.cnf.d/server.cnf添加</p>\n<pre><code>innodb_file_per_table=ON\nskip_name_resolve=ON\nserver_id=2\nrelay_log=relay-log\n</code></pre><p>添加master参数</p>\n<pre><code>MariaDB [(none)]&gt; CHANGE  MASTER TO MASTER_HOST=&#39;172.18.50.72&#39;,MASTER_USER=&#39;test&#39;,MASTER_PASSWORD=&#39;test123&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000003&#39;,MASTER_LOG_POS=493;\n</code></pre><p>启动slave</p>\n<pre><code>MariaDB [(none)]&gt; START SLAVE;\n</code></pre><p>安装插件</p>\n<pre><code>MariaDB [(none)]&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME &#39;semisync_slave&#39;;\n</code></pre><p>重启slave IO线程</p>\n<pre><code>MariaDB [(none)]&gt; STOP SLAVE IO_THREAD;\nQuery OK, 0 rows affected (0.00 sec)\n\nMariaDB [(none)]&gt; START SLAVE IO_THREAD;\nQuery OK, 0 rows affected (0.01 sec)\n</code></pre><p>判断是否成功<br>主节点</p>\n<pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS  LIKE &#39;Rpl_semi_sync_master_clients&#39;;\n+------------------------------+-------+\n| Variable_name                | Value |\n+------------------------------+-------+\n| Rpl_semi_sync_master_clients | 1     |\n+------------------------------+-------+\n1 row in set (0.01 sec)\n</code></pre><p>查看相关参数</p>\n<pre><code>MariaDB [mydb]&gt; SHOW GLOBAL STATUS  LIKE &#39;%semi%&#39;;\n+--------------------------------------------+-------+\n| Variable_name                              | Value |\n+--------------------------------------------+-------+\n| Rpl_semi_sync_master_clients               | 1     |\n| Rpl_semi_sync_master_net_avg_wait_time     | 552   |\n| Rpl_semi_sync_master_net_wait_time         | 1657  |\n| Rpl_semi_sync_master_net_waits             | 3     |\n| Rpl_semi_sync_master_no_times              | 0     |\n| Rpl_semi_sync_master_no_tx                 | 0     |\n| Rpl_semi_sync_master_status                | ON    |\n| Rpl_semi_sync_master_timefunc_failures     | 0     |\n| Rpl_semi_sync_master_tx_avg_wait_time      | 562   |\n| Rpl_semi_sync_master_tx_wait_time          | 1687  |\n| Rpl_semi_sync_master_tx_waits              | 3     |\n| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |\n| Rpl_semi_sync_master_wait_sessions         | 0     |\n| Rpl_semi_sync_master_yes_tx                | 3     |\n+--------------------------------------------+-------+\n14 rows in set (0.00 sec)\n</code></pre><h4 id=\"复制过滤器\"><a href=\"#复制过滤器\" class=\"headerlink\" title=\"复制过滤器\"></a>复制过滤器</h4><p>仅复制有限的一个或几个数据库相关的数据，而非所有；由复制过滤器进行；<br>两种实现方法：</p>\n<ol>\n<li>主服务器<br>主服务器仅向二进制日志中记录有关特定数据相关的写操作<br>问题：其他库的point-recovery将无从实现<pre><code>binlog_do_db=    #白名单\nbinlog_ignore_db=    #黑名单\n</code></pre></li>\n<li>从服务器<br>从服务器的SQL THREAD仅重放关注的数据库或表的相关事件，并将其应用于本地；<br>问题：网络IO和磁盘IO<pre><code>Replicate_Do_DB=\nReplicate_Ignore_DB=\nReplicate_Do_Table=\nReplicate_Ignore_Table=\nReplicate_Wild_Do_DB=    #根据表面通配符做白名单\nReplicate__Wild_Ignore_DB=    #根据表面通配符做黑名单\n</code></pre></li>\n</ol>\n","categories":[],"tags":[{"name":"Mariadb","path":"api/tags/Mariadb.json"}]}