{"title":"编译安装bind","slug":"bind编译安装","date":"2017-04-18T06:14:08.000Z","updated":"2017-11-19T13:15:37.000Z","comments":true,"excerpt":"","content":"<h2 id=\"bind编译安装\"><a href=\"#bind编译安装\" class=\"headerlink\" title=\"bind编译安装\"></a>bind编译安装</h2><p>解压源码包</p>\n<blockquote>\n<p>tar xvf bin9.tar.gz</p>\n</blockquote>\n<p>添加named用户</p>\n<blockquote>\n<p>useradd -r -s /sbin/nologin -d /var/named -u 53 named</p>\n</blockquote>\n<p>创建用户家目录并修改所属组及其权限</p>\n<blockquote>\n<p>mkdir /var/named</p>\n<p>chown root.named /var/named</p>\n<p>chmod 770 /var/named</p>\n</blockquote>\n<p>安装依赖</p>\n<blockquote>\n<p>yum install gcc  openssl-devel -y</p>\n</blockquote>\n<p>编译安装</p>\n<blockquote>\n<p>./configure –prefix=/usr/local/dns  –sysconfdir=/etc/named</p>\n<p>make &amp;&amp; make install</p>\n</blockquote>\n<p>将生成打文件加入path变量</p>\n<blockquote>\n<p>vim /etc/profie.d/bind9.sh</p>\n<p>PATH=$PATH:/usr/local/dns/bin:/usr/local/dns/sbin</p>\n<p>source /etc/profile.d/bind8.sh</p>\n</blockquote>\n<p>添加man帮助</p>\n<blockquote>\n<p>vim /etc/man_db.conf</p>\n<p>MANDATORY_MANPATH                       /usr/local/dns/share/man</p>\n<p>mandb</p>\n</blockquote>\n<p>添加配置文件</p>\n<blockquote>\n<p>vim /etc/named/named.conf</p>\n<p>options {</p>\n<p>​    directory “/var/named”;</p>\n<p>};</p>\n<p>zone “test.com” {</p>\n<p>​    type master;</p>\n<p>​    file “test.com.zone”;</p>\n<p>};</p>\n</blockquote>\n<p>添加zone文件</p>\n<blockquote>\n<p>[root@shen named]# cat test.com.zone<br>$TTL 86400<br>@ IN SOA dns1 root.test.com. ( 1 1D 1h 1w 1h )</p>\n<p>​    NS    dns1</p>\n<p>dns1    A    172.18.50.71<br>www    CNAME    web<br>web    A    172.18.50.71</p>\n</blockquote>\n<p>确保named用户对其可读</p>\n<p>named-checkconf 检查配置文件语法是否正确</p>\n<p>named-checkzone “test.com” /var/named/test.com.zone 检查zone文件</p>\n<p>启动服务</p>\n<blockquote>\n<p>named</p>\n</blockquote>\n<p>测试</p>\n<blockquote>\n<p>[root@shen named]# dig www.test.com @127.0.0.1</p>\n<p>; &lt;&lt;&gt;&gt; DiG 9.11.0-P5 &lt;&lt;&gt;&gt; www.test.com @127.0.0.1<br>;; global options: +cmd<br>;; Got answer:<br>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 6599<br>;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 2</p>\n<p>;; OPT PSEUDOSECTION:<br>; EDNS: version: 0, flags:; udp: 4096<br>; COOKIE: 6765dbacd3bfd785ae70758258f5822040069e69289113fa (good)<br>;; QUESTION SECTION:<br>;www.test.com.            IN    A</p>\n<p>;; ANSWER SECTION:<br>www.test.com.        86400    IN    CNAME    web.test.com.<br>web.test.com.        86400    IN    A    172.18.50.71</p>\n<p>;; AUTHORITY SECTION:<br>test.com.        86400    IN    NS    dns1.test.com.</p>\n<p>;; ADDITIONAL SECTION:<br>dns1.test.com.        86400    IN    A    172.18.50.71</p>\n<p>;; Query time: 0 msec<br>;; SERVER: 127.0.0.1#53(127.0.0.1)<br>;; WHEN: Mon Apr 17 23:04:00 EDT 2017<br>;; MSG SIZE  rcvd: 138</p>\n</blockquote>\n<p>切换到前台执行</p>\n<blockquote>\n<p>yum provides killall</p>\n<p>yum install psmisc-22.20-11.el7.x86_64      </p>\n<p>killall named</p>\n<p> named -f -d 3 -g</p>\n</blockquote>\n<p>添加根节点</p>\n<blockquote>\n<p>dig -t NS . &gt; /var/named/namd.ca</p>\n<p>vim /etc/named/named.conf</p>\n<p>zone “.” {</p>\n<p>​    type hint;</p>\n<p>​    file “named.ca”;</p>\n<p>};</p>\n</blockquote>\n<p>rndc错误</p>\n<blockquote>\n<p>[root@shen named]# rndc status<br>rndc: neither /etc/named/rndc.conf nor /etc/named/rndc.key was found</p>\n</blockquote>\n<p>修复</p>\n<blockquote>\n<p>rndc-confgen -r /dev/urandom  &gt; /etc/named/rndc.conf</p>\n<p>tail -n 12 rndc.conf | sed ‘s/# //‘ &gt;&gt; /etc/named/named.conf </p>\n<p>vim /etc/named/named.conf</p>\n<p>删除 Use with 以及End of name 这两行</p>\n<p>重启服务后</p>\n<p>[root@shen named]# rndc status<br>version: BIND 9.11.0-P5 <id:ad4fb79><br>running on shen.org: Linux x86_64 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016<br>boot time: Tue, 18 Apr 2017 03:41:03 GMT<br>last configured: Tue, 18 Apr 2017 03:41:03 GMT<br>configuration file: /etc/named/named.conf<br>CPUs found: 1<br>worker threads: 1<br>UDP listeners per interface: 1<br>number of zones: 100 (98 automatic)<br>debug level: 3<br>xfers running: 0<br>xfers deferred: 0<br>soa queries in progress: 0<br>query logging is OFF<br>recursive clients: 0/900/1000<br>tcp clients: 0/150<br>server is up and running</id:ad4fb79></p>\n</blockquote>\n<p>压力测试</p>\n<blockquote>\n<p>cd /root/bind-9.11.0-P5/contrib/queryperf</p>\n<p>./cconfigure</p>\n<p>make</p>\n<p>/root/bind-9.11.0-P5/contrib/queryperf</p>\n<p>vim  ~/test.txt</p>\n<p>www.test.com A</p>\n<p>test.com NS</p>\n<p>:1,$y</p>\n<p>多复制一点</p>\n<p>/root/bind-9.11.0-P5/contrib/queryperf</p>\n</blockquote>\n<p>打开日志功能</p>\n<blockquote>\n<p>rndc querylog</p>\n<p>rndc status</p>\n</blockquote>\n<p>dns排错</p>\n<blockquote>\n<p>NXDOMAIN: the queried name does not exits in the zone.</p>\n<p>可能是CNAME对应打A记录不存在导致</p>\n<p>REFUSED: The nameserver refused the client’s DNS</p>\n<p>可能是DNS策略导致</p>\n<p>避免CNAME指向CNAME记录,可能产生回环<br>test.example.com. IN CNAME lab.example.com.<br>lab.example.com. IN CNAME test.example.com.</p>\n<p>正确配置PTR记录,许多服务依赖PTR,如sshd,MTA</p>\n</blockquote>\n","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"bind","path":"api/tags/bind.json"}]}