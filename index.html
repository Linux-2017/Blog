<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Pursuit Blog&#39;s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Pursuit Blog&#39;s">
<meta property="og:url" content="https://shensir.info/index.html">
<meta property="og:site_name" content="Pursuit Blog&#39;s">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pursuit Blog&#39;s">
  
    <link rel="alternate" href="/atom.xml" title="Pursuit Blog&#39;s" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Pursuit Blog&#39;s</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://shensir.info"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Fastdfs安装配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/12/Fastdfs安装配置/" class="article-date">
  <time datetime="2017-06-12T13:28:08.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/Fastdfs安装配置/">Fastdfs安装配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Fastdfs安装配置"><a href="#Fastdfs安装配置" class="headerlink" title="Fastdfs安装配置"></a>Fastdfs安装配置</h2><blockquote>
<p>项目地址：<a href="https://github.com/happyfish100" target="_blank" rel="noopener">https://github.com/happyfish100</a></p>
</blockquote>
<h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p><img src="http://omsab2via.bkt.clouddn.com/fastdfs.png" alt="enter image description here"></p>
<p>###安装前<br>所有节点均需</p>
<pre><code>iptables -F
setenforce 0
yum -y install gcc perl
yum -y install pcre-devel openssl-devel
yum -y install ntp
ntpdate time1.aliyun.com
</code></pre><h3 id="71配置"><a href="#71配置" class="headerlink" title="71配置"></a>71配置</h3><pre><code>git clone https://github.com/happyfish100/fastdfs.git
git clone https://github.com/happyfish100/libfastcommon.git
</code></pre><p>分别cd进去./make.sh &amp;&amp; ./make install<br>复制配置文件至指定目录</p>
<pre><code>cd /root/fastdfs/conf
cp {http.conf,mime.types，anti-steal.jpg} /etc/fdfs/
</code></pre><p>准备配置文件</p>
<pre><code>cd /etc/fdfs
cp tracker.conf.sample tracker.conf
[root@71 fdfs]# cat tracker.conf |grep -v &#39;^#&#39;|grep -v &quot;^$&quot;
disabled=false
bind_addr=
port=22122
connect_timeout=30
network_timeout=60
base_path=/fastdfs        #程序目录，需手动创建
max_connections=256
accept_threads=1
work_threads=4
min_buff_size = 8KB
max_buff_size = 128KB
store_lookup=0            #这里0表示轮询下面两个组
store_group=group0
store_group=group1
store_server=0
store_path=0
download_server=0
reserved_storage_space = 10%
log_level=info
run_by_group=
run_by_user=
allow_hosts=*
sync_log_buff_interval = 10
check_active_interval = 120
thread_stack_size = 64KB
storage_ip_changed_auto_adjust = true
storage_sync_file_max_delay = 86400
storage_sync_file_max_time = 300
use_trunk_file = false 
slot_min_size = 256
slot_max_size = 16MB
trunk_file_size = 64MB
trunk_create_file_advance = false
trunk_create_file_time_base = 02:00
trunk_create_file_interval = 86400
trunk_create_file_space_threshold = 20G
trunk_init_check_occupying = false
trunk_init_reload_from_binlog = false
trunk_compress_binlog_min_interval = 0
use_storage_id = false
storage_ids_filename = storage_ids.conf
id_type_in_filename = ip
store_slave_file_use_link = false
rotate_error_log = false
error_log_rotate_time=00:00
rotate_error_log_size = 0
log_file_keep_days = 0
use_connection_pool = false
connection_pool_max_idle_time = 3600
http.server_port=80
http.check_alive_interval=30
http.check_alive_type=tcp
http.check_alive_uri=/status.html
</code></pre><p>安装完成后会自动创建unit file,所以<br>service fdfs_trackerd start</p>
<p>nginx配置</p>
<pre><code>yum -y Install nginx
在nginx.conf server配置段中加入
    upstream fastdfs0 {
        server 172.18.50.72;
        server 172.18.50.73;
    }

    upstream fastdfs1 {
        server 172.18.50.62;
        server 172.18.50.63;
    }
default.conf中加入
    location /group0/M00 {
        proxy_pass http://fastdfs0;
    }
    location /group1/M00 {
        proxy_pass http://fastdfs1;
    }
</code></pre><p>###72配置</p>
<pre><code>git clone https://github.com/happyfish100/fastdfs.git
git clone https://github.com/happyfish100/libfastcommon.git
</code></pre><p>分别cd进去./make.sh &amp;&amp; ./make install<br>复制配置文件至指定目录</p>
<pre><code>cd /root/fastdfs/conf
cp {http.conf,mime.types，anti-steal.jpg} /etc/fdfs/
</code></pre><p>####准备配置文件</p>
<pre><code>mkdir -pv /data/fastdfs
cd /etc/fdfs/
cp storage.conf.sample storage.conf
[root@72 fdfs]# cat /etc/fdfs/storage.conf|grep -Ev &quot;^(#|$)&quot;
disabled=false
group_name=group0            #组名
bind_addr=
client_bind=true
port=23000
connect_timeout=30
network_timeout=60
heart_beat_interval=30
stat_report_interval=60
base_path=/data/fastdfs
max_connections=256
buff_size = 256KB
accept_threads=1
work_threads=4
disk_rw_separated = true
disk_reader_threads = 1
disk_writer_threads = 1
sync_wait_msec=50
sync_interval=0
sync_start_time=00:00
sync_end_time=23:59
write_mark_file_freq=500
store_path_count=1
store_path0=/data/fastdfs            #数据存放目录
subdir_count_per_path=256
tracker_server=172.18.50.71:22122    #tracker节点
log_level=info
run_by_group=
run_by_user=
allow_hosts=*
file_distribute_path_mode=0
file_distribute_rotate_count=100
fsync_after_written_bytes=0
sync_log_buff_interval=10
sync_binlog_buff_interval=10
sync_stat_file_interval=300
thread_stack_size=512KB
upload_priority=10
if_alias_prefix=
check_file_duplicate=0
file_signature_method=hash
key_namespace=FastDFS
keep_alive=0
use_access_log = false
rotate_access_log = false
access_log_rotate_time=00:00
rotate_error_log = false
error_log_rotate_time=00:00
rotate_access_log_size = 0
rotate_error_log_size = 0
log_file_keep_days = 0
file_sync_skip_invalid_record=false
use_connection_pool = false
connection_pool_max_idle_time = 3600
http.domain_name=
http.server_port=80                ##http端口
</code></pre><p>启动服务<br>service fdfs_storaged start</p>
<p>####安装nginx进行反代<br>git clone <a href="https://github.com/happyfish100/fastdfs-nginx-module.git" target="_blank" rel="noopener">https://github.com/happyfish100/fastdfs-nginx-module.git</a><br>准备nginx源码包，我这里使用1.10.3版本</p>
<pre><code>tar xvf nginx-1.10.3.tar.gz
cd nginx-1.10.3
./configure   --prefix=/usr   \
--sbin-path=/usr/sbin/nginx   \
--conf-path=/etc/nginx/nginx.conf   \
--error-log-path=/var/log/nginx/error.log   \
--http-log-path=/var/log/nginx/access.log   \
--pid-path=/var/run/nginx/nginx.pid    \
--lock-path=/var/lock/nginx.lock   \
--user=nginx   \
--group=nginx   \
--with-http_ssl_module   \
--with-http_flv_module  \
--with-http_stub_status_module   \
--with-http_gzip_static_module   \
--http-client-body-temp-path=/var/tmp/nginx/client/   \
--http-proxy-temp-path=/var/tmp/nginx/proxy/   \
--http-fastcgi-temp-path=/var/tmp/nginx/fcgi/   \
--http-uwsgi-temp-path=/var/tmp/nginx/uwsgi   \
--http-scgi-temp-path=/var/tmp/nginx/scgi   \
--with-pcre   \
--with-debug   \
--add-module=../fastdfs-nginx-module/src
make &amp;&amp; make install
</code></pre><p>修改配置文件，在nginx配置文件中加入</p>
<pre><code>location /M00 {
      root /data/fastdfs/data;
      ngx_fastdfs_module;
}
</code></pre><p>添加unit file</p>
<pre><code>vim /etc/init.d/nginx
[root@72 fdfs]# cat /etc/init.d/nginx 
#!/bin/sh
#
# nginx - this script starts and stops the nginx daemon
#
# chkconfig:   - 85 15 
# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \
#               proxy and IMAP/POP3 proxy server
# processname: nginx
# config:      /etc/nginx/nginx.conf
# config:      /etc/sysconfig/nginx
# pidfile:     /var/run/nginx.pid

# Source function library.
. /etc/rc.d/init.d/functions

# Source networking configuration.
. /etc/sysconfig/network

# Check that networking is up.
[ &quot;$NETWORKING&quot; = &quot;no&quot; ] &amp;&amp; exit 0

nginx=&quot;/usr/sbin/nginx&quot;
prog=$(basename $nginx)

NGINX_CONF_FILE=&quot;/etc/nginx/nginx.conf&quot;

[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx

lockfile=/var/lock/subsys/nginx

make_dirs() {
   # make required directories
   user=`nginx -V 2&gt;&amp;1 | grep &quot;configure arguments:&quot; | sed &#39;s/[^*]*--user=\([^ ]*\).*/\1/g&#39; -`
   options=`$nginx -V 2&gt;&amp;1 | grep &#39;configure arguments:&#39;`
   for opt in $options; do
       if [ `echo $opt | grep &#39;.*-temp-path&#39;` ]; then
           value=`echo $opt | cut -d &quot;=&quot; -f 2`
           if [ ! -d &quot;$value&quot; ]; then
               # echo &quot;creating&quot; $value
               mkdir -p $value &amp;&amp; chown -R $user $value
           fi
       fi
   done
}

start() {
    [ -x $nginx ] || exit 5
    [ -f $NGINX_CONF_FILE ] || exit 6
    make_dirs
    echo -n $&quot;Starting $prog: &quot;
    daemon $nginx -c $NGINX_CONF_FILE
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; touch $lockfile
    return $retval
}

stop() {
    echo -n $&quot;Stopping $prog: &quot;
    killproc $prog -QUIT
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile
    return $retval
}

restart() {
    configtest || return $?
    stop
    sleep 1
    start
}

reload() {
    configtest || return $?
    echo -n $&quot;Reloading $prog: &quot;
    killproc $nginx -HUP
    RETVAL=$?
    echo
}

force_reload() {
    restart
}

configtest() {
  $nginx -t -c $NGINX_CONF_FILE
}

rh_status() {
    status $prog
}

rh_status_q() {
    rh_status &gt;/dev/null 2&gt;&amp;1
}

case &quot;$1&quot; in
    start)
        rh_status_q &amp;&amp; exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart|configtest)
        $1
        ;;
    reload)
        rh_status_q || exit 7
        $1
        ;;
    force-reload)
        force_reload
        ;;
    status)
        rh_status
        ;;
    condrestart|try-restart)
        rh_status_q || exit 0
            ;;
    *)
        echo $&quot;Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}&quot;
        exit 2
esac
</code></pre><p>将fastdnf配置文件复制到/etc/fdfs</p>
<pre><code>cd /root/fastdfs-nginx-module/src
cp mod_fastdfs.conf /etc/fdfs
</code></pre><p>配置如下</p>
<pre><code>[root@72 fdfs]# cat mod_fastdfs.conf | grep -Ev &quot;^(#|$)&quot;
connect_timeout=2
network_timeout=30
base_path=/data/fastdfs/logs            #日志文件存放位置
load_fdfs_parameters_from_tracker=true
storage_sync_file_max_delay = 86400
use_storage_id = false
storage_ids_filename = storage_ids.conf
tracker_server=172.18.50.71:22122        #tracker服务器地址
storage_server_port=23000
group_name=group0                        #组名
url_have_group_name = true                #多组需开启，在url显示组名
store_path_count=1
store_path0=/data/fastdfs                #data目录
log_level=info
log_filename=
response_mode=proxy
if_alias_prefix=
flv_support = true
flv_extension = flv
group_count = 0
</code></pre><p>添加nginx用户</p>
<pre><code>useradd -r nginx -s /sbin/nologin
</code></pre><p>然后就可以启动服务了<br>创建链接文件<br>ln -s /data/fastdfs/data  /data/fastdfs/data/M00<br>然后重启nginx</p>
<p>另外3台的配置除组名外基本一致，这里就不写了</p>
<p>###测试<br>准备client<br>安装fastdfs<br>准备配置文件</p>
<pre><code>[root@71 ~]# cat  /etc/fdfs/client.conf.sample |grep -Ev &quot;^(#|$)&quot;
connect_timeout=30
network_timeout=60
base_path=/data/
tracker_server=172.18.50.71:22122
log_level=info
use_connection_pool = false
connection_pool_max_idle_time = 3600
load_fdfs_parameters_from_tracker=false
use_storage_id = false
storage_ids_filename = storage_ids.conf
http.tracker_server_port=80
</code></pre><p>上传文件</p>
<pre><code>[root@71 ~]# fdfs_upload_file /etc/fdfs/client.conf.sample a.txt 
group0/M00/00/00/rBIySFk-i8iAXDN7AAAEXxgxbAk905.txt
[root@71 ~]# fdfs_upload_file /etc/fdfs/client.conf.sample a.txt 
group1/M00/00/00/rBIyP1k-i8iAUolVAAAEXxgxbAk832.txt
</code></pre><p>访问测试</p>
<pre><code>curl http://172.18.50.71/group1/M00/00/00/rBIyP1k-i8iAUolVAAAEXxgxbAk832.txt
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
systemd-bus-proxy:x:999:997:systemd Bus Proxy:/:/sbin/nologin
systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
polkitd:x:998:996:User for polkitd:/:/sbin/nologin
tss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
chrony:x:997:995::/var/lib/chrony:/sbin/nologin
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
nginx:x:996:994:nginx user:/var/cache/nginx:/sbin/nologin
</code></pre><pre><code>curl http://172.18.50.71/group0/M00/00/00/rBIySFk-i8iAXDN7AAAEXxgxbAk905.txt
curl http://172.18.50.71/group1/M00/00/00/rBIyP1k-i8iAUolVAAAEXxgxbAk832.txt
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
systemd-bus-proxy:x:999:997:systemd Bus Proxy:/:/sbin/nologin
systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
polkitd:x:998:996:User for polkitd:/:/sbin/nologin
tss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
chrony:x:997:995::/var/lib/chrony:/sbin/nologin
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
nginx:x:996:994:nginx user:/var/cache/nginx:/sbin/nologin
</code></pre><h3 id="一些注意的地方"><a href="#一些注意的地方" class="headerlink" title="一些注意的地方"></a>一些注意的地方</h3><p>72 73两台centos7.3在修改/etc/fdfs/mod_fastdfs.conf<br>url_have_group_name = true后配置nginx反代<br>location /group0/M00 {<br>            root /data/fastdfs/data;<br>            ngx_fastdfs_module;<br>        }<br> 后无法访问<br> 需要在数据存放目录建立一个group0的软连接，而62 、63的cent6.8则一切正常。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/06/12/Fastdfs安装配置/" data-id="cjb05oymh00019fzuo8yh03zo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fastdfs/">Fastdfs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Maradb主主复制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/12/Maradb主主复制/" class="article-date">
  <time datetime="2017-06-12T13:28:08.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/Maradb主主复制/">Maradb主主复制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Maradb主主复制"><a href="#Maradb主主复制" class="headerlink" title="Maradb主主复制"></a>Maradb主主复制</h2><blockquote>
<p>互为主从：两个节点各自都要开启binlog和relay log；</p>
</blockquote>
<ol>
<li>数据不一致；</li>
<li>自动增长id；</li>
</ol>
<p><strong>定义一个节点使用奇数id</strong></p>
<pre><code>auto_increment_offset=1
auto_increment_increment=2
</code></pre><p><strong>定义一个节点使用偶数id</strong></p>
<pre><code>auto_increment_offset=2
auto_increment_increment=2
</code></pre><h4 id="MASTER1-172-18-50-72"><a href="#MASTER1-172-18-50-72" class="headerlink" title="MASTER1(172.18.50.72)"></a>MASTER1(172.18.50.72)</h4><p>/etc/my.cnf.d/server.cnf添加</p>
<pre><code>innodb_file_per_table=ON
skip_name_resolve=ON
log_bin=mysql-bin
server_id=1
relay_log=relay-log
auto_increment_offset=1
auto_increment_increment=2
</code></pre><p>授权slave服务器</p>
<pre><code>GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO test@&#39;172.18.50.73&#39; IDENTIFIED BY &#39;test123&#39;;
</code></pre><p>查看二进制文件</p>
<pre><code>MariaDB [(none)]&gt; SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000003 |      491 |              |                  |
+------------------+----------+--------------+------------------+
</code></pre><p>同步参数配置</p>
<pre><code>CHANGE MASTER TO MASTER_HOST=&#39;172.18.50.73&#39;,MASTER_USER=&#39;test&#39;,MASTER_PASSWORD=&#39;test123&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000003&#39;,MASTER_LOG_POS=491;
</code></pre><p>开启slave</p>
<pre><code>START SLAVE;
</code></pre><h4 id="MASTER2-172-18-50-73"><a href="#MASTER2-172-18-50-73" class="headerlink" title="MASTER2(172.18.50.73)"></a>MASTER2(172.18.50.73)</h4><p>/etc/my.cnf.d/server.cnf添加</p>
<pre><code>innodb_file_per_table=ON
skip_name_resolve=ON
log_bin=mysql-bin
server_id=2
relay_log=relay-log
auto_increment_offset=2
auto_increment_increment=2
</code></pre><p>授权slave服务器</p>
<pre><code>GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO test@&#39;172.18.50.72&#39; IDENTIFIED BY &#39;test123&#39;;
</code></pre><p>查看二进制文件</p>
<pre><code>MariaDB [(none)]&gt; SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000003 |      491 |              |                  |
+------------------+----------+--------------+------------------+
</code></pre><p>同步参数配置</p>
<pre><code>CHANGE MASTER TO MASTER_HOST=&#39;172.18.50.72&#39;,MASTER_USER=&#39;test&#39;,MASTER_PASSWORD=&#39;test123&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000003&#39;,MASTER_LOG_POS=491;
</code></pre><p>开启slave</p>
<pre><code>START SLAVE;
</code></pre><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>MASTER1</p>
<pre><code>CREATE TABLE tbl1 (id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,name VARCHAR(20));
insert into tbl1 (name) VALUES (&#39;a1&#39;),(&#39;a2&#39;);
</code></pre><p>MASTER2</p>
<pre><code>insert into tbl1 (name) VALUES (&#39;a1&#39;),(&#39;a2&#39;);
MariaDB [mytest]&gt; select * from tbl1;
+----+------+
| id | name |
+----+------+
|  1 | a1   |
|  3 | a2   |
|  4 | a1   |
|  6 | a2   |
+----+------+
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/06/12/Maradb主主复制/" data-id="cjb05oymn00059fzuixpozqgm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Maradb/">Maradb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Mariadb半同步复制及复制过滤器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/12/Mariadb半同步复制及复制过滤器/" class="article-date">
  <time datetime="2017-06-12T13:28:08.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/Mariadb半同步复制及复制过滤器/">Mariadb半同步复制及复制过滤器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Mariadb半同步复制及复制过滤器"><a href="#Mariadb半同步复制及复制过滤器" class="headerlink" title="Mariadb半同步复制及复制过滤器"></a>Mariadb半同步复制及复制过滤器</h2><p>依赖的插件<br>/usr/lib64/mysql/plugin下</p>
<blockquote>
<p>semisync_master.so<br>semisync_slave.so</p>
</blockquote>
<h4 id="MASTER-172-18-50-72"><a href="#MASTER-172-18-50-72" class="headerlink" title="MASTER(172.18.50.72)"></a>MASTER(172.18.50.72)</h4><p>/etc/my.cnf.d/server.cnf配置</p>
<pre><code>innodb_file_per_table=ON
skip_name_resolve=ON
log_bin=mysql-bin
server_id=1
</code></pre><p>授权slave服务器</p>
<pre><code>GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO test@&#39;172.18.50.73&#39; IDENTIFIED BY &#39;test123&#39;;
</code></pre><p>查看二进制文件</p>
<pre><code>MariaDB [(none)]&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000003 |      493 |              |                  |
+------------------+----------+--------------+------------------+
1 row in set (0.00 sec)
</code></pre><p>安装插件</p>
<pre><code>MariaDB [(none)]&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME &#39;semisync_master.so&#39;;
</code></pre><p>查看是否安装成功</p>
<pre><code>MariaDB [(none)]&gt; SHOW PLUGINS;
rpl_semi_sync_master           | ACTIVE   | REPLICATION        | semisync_master.so | GPL
</code></pre><p>开启rpl_semi_sync_master_enabled</p>
<pre><code>SHOW VARIABLES LIKE &#39;%semi%&#39;;
SET @@GLOBAL.rpl_semi_sync_master_enabled=ON
</code></pre><h4 id="SLAVE-172-18-50-73"><a href="#SLAVE-172-18-50-73" class="headerlink" title="SLAVE(172.18.50.73)"></a>SLAVE(172.18.50.73)</h4><p>/etc/my.cnf.d/server.cnf添加</p>
<pre><code>innodb_file_per_table=ON
skip_name_resolve=ON
server_id=2
relay_log=relay-log
</code></pre><p>添加master参数</p>
<pre><code>MariaDB [(none)]&gt; CHANGE  MASTER TO MASTER_HOST=&#39;172.18.50.72&#39;,MASTER_USER=&#39;test&#39;,MASTER_PASSWORD=&#39;test123&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000003&#39;,MASTER_LOG_POS=493;
</code></pre><p>启动slave</p>
<pre><code>MariaDB [(none)]&gt; START SLAVE;
</code></pre><p>安装插件</p>
<pre><code>MariaDB [(none)]&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME &#39;semisync_slave&#39;;
</code></pre><p>重启slave IO线程</p>
<pre><code>MariaDB [(none)]&gt; STOP SLAVE IO_THREAD;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]&gt; START SLAVE IO_THREAD;
Query OK, 0 rows affected (0.01 sec)
</code></pre><p>判断是否成功<br>主节点</p>
<pre><code>MariaDB [(none)]&gt; SHOW GLOBAL STATUS  LIKE &#39;Rpl_semi_sync_master_clients&#39;;
+------------------------------+-------+
| Variable_name                | Value |
+------------------------------+-------+
| Rpl_semi_sync_master_clients | 1     |
+------------------------------+-------+
1 row in set (0.01 sec)
</code></pre><p>查看相关参数</p>
<pre><code>MariaDB [mydb]&gt; SHOW GLOBAL STATUS  LIKE &#39;%semi%&#39;;
+--------------------------------------------+-------+
| Variable_name                              | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients               | 1     |
| Rpl_semi_sync_master_net_avg_wait_time     | 552   |
| Rpl_semi_sync_master_net_wait_time         | 1657  |
| Rpl_semi_sync_master_net_waits             | 3     |
| Rpl_semi_sync_master_no_times              | 0     |
| Rpl_semi_sync_master_no_tx                 | 0     |
| Rpl_semi_sync_master_status                | ON    |
| Rpl_semi_sync_master_timefunc_failures     | 0     |
| Rpl_semi_sync_master_tx_avg_wait_time      | 562   |
| Rpl_semi_sync_master_tx_wait_time          | 1687  |
| Rpl_semi_sync_master_tx_waits              | 3     |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |
| Rpl_semi_sync_master_wait_sessions         | 0     |
| Rpl_semi_sync_master_yes_tx                | 3     |
+--------------------------------------------+-------+
14 rows in set (0.00 sec)
</code></pre><h4 id="复制过滤器"><a href="#复制过滤器" class="headerlink" title="复制过滤器"></a>复制过滤器</h4><p>仅复制有限的一个或几个数据库相关的数据，而非所有；由复制过滤器进行；<br>两种实现方法：</p>
<ol>
<li>主服务器<br>主服务器仅向二进制日志中记录有关特定数据相关的写操作<br>问题：其他库的point-recovery将无从实现<pre><code>binlog_do_db=    #白名单
binlog_ignore_db=    #黑名单
</code></pre></li>
<li>从服务器<br>从服务器的SQL THREAD仅重放关注的数据库或表的相关事件，并将其应用于本地；<br>问题：网络IO和磁盘IO<pre><code>Replicate_Do_DB=
Replicate_Ignore_DB=
Replicate_Do_Table=
Replicate_Ignore_Table=
Replicate_Wild_Do_DB=    #根据表面通配符做白名单
Replicate__Wild_Ignore_DB=    #根据表面通配符做黑名单
</code></pre></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/06/12/Mariadb半同步复制及复制过滤器/" data-id="cjb05oymo00069fzul3xvn1gq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mariadb/">Mariadb</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-MogileFS的安装配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/12/MogileFS的安装配置/" class="article-date">
  <time datetime="2017-06-12T13:28:08.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/MogileFS的安装配置/">MogileFS的安装配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="MogileFS的安装配置"><a href="#MogileFS的安装配置" class="headerlink" title="MogileFS的安装配置"></a>MogileFS的安装配置</h2><p><strong>该项目托管在github之上，地址为<a href="https://github.com/hachi" target="_blank" rel="noopener">https://github.com/hachi</a></strong></p>
<h3 id="MogileFS由3个部分组成："><a href="#MogileFS由3个部分组成：" class="headerlink" title="MogileFS由3个部分组成："></a>MogileFS由3个部分组成：</h3><ol>
<li>server：主要包括mogilefsd和mogstored两个应用程序。mogilefsd实现的是tracker，它通过数据库来保存元数据信息，包括站点doman、class、host等；mogstored是存储节点(store node),它其实是个WebDAV服务，默认监听在7500端口，接受客户端的文件存储请求。在MogileFS安装完后，要运行mogadm工具将所有的store node注册到mogilefsd的数据库里，mogilefsd会对这些节点进行管理和监控。</li>
<li>utiles（工具集）：主要是MofileFS的一些管理工具，例如mogadm等。</li>
<li>客户端API：MogileFS的客户端API很多，例如Perl、PHP、Java、Python等，用这个模块可以编写客户端程序，实现文件的备份管理功能等。</li>
</ol>
<p>存储主机（节点）<br>这个是MogileFS存储文件存放在这些机器上，也是mogstored节点，也叫Storage Server，每一台存储主要都要启动一个mogstored服务，扩容就是增加这些机器。</p>
<p>设备（device）<br>一个存储节点，可以有多个device，就是用来存放文件的目录（例如挂载的目录），每个设备都有一个设备id，需要在mogstored的配置文件中的docroot配置的项目，指定的目录下面创建相应的设备的目录，目录名为\$docroot/dev\$id,设备是不能删除的，只能将其设备的状态值为dead，当一个设备dead之后，里面的数据无法恢复，且这个dead了的设备id也将不能用了。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>实验环境为4台centos6.8，分别配置epel源，时间已经同步，且防护墙、selinux已关闭。</p>
<p><strong>拓扑</strong><br>nginx反代、tracker以及mysq都在<br>172.18.50.61</p>
<p>3台storage node<br>172.18.50.62<br>172.18.50.63<br>172.18.50.64</p>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p>为了节省时间，这里在61主机上使用ansible进行配置<br>ansible的hosts配置为<br>[my]<br>172.18.50.61<br>[mgs]<br>172.18.50.62<br>172.18.50.63<br>172.18.50.64</p>
<p>安装perl环境</p>
<pre><code>ansible all -m shell -a &#39;yum install perl-Net-Netmask perl-IO-stringy perl-Sys-Syslog perl-IO-AIO&#39;
</code></pre><p>准备mogilefs文件<br>[root@61 rpm]# ls /root/rpm<br>MogileFS-Server-2.46-2.el6.noarch.rpm            perl-Danga-Socket-1.61-1.el6.rf.noarch.rpm<br>MogileFS-Server-mogilefsd-2.46-2.el6.noarch.rpm  perl-IO-stringy-2.110-1.2.el6.rfx.noarch.rpm<br>MogileFS-Server-mogstored-2.46-2.el6.noarch.rpm  perl-MogileFS-Client-1.14-1.el6.noarch.rpm<br>MogileFS-Utils-2.19-1.el6.noarch.rpm             perl-Net-Netmask-1.9015-8.el6.noarch.rpm<br>Perlbal-1.78-1.el6.noarch.rpm                    perl-Perlbal-1.78-1.el6.noarch.rpm<br>Perlbal-doc-1.78-1.el6.noarch.rpm</p>
<p>将这些文件推送至store node</p>
<pre><code>[root@61 ~]# cat copy.yml 
---

- hosts: mgs
  remote_user: root
  tasks:
  - name: COPY
    copy: src=/root/rpm dest=/tmp
</code></pre><p>copy模块依赖libselinux，所以</p>
<pre><code>ansible all -m shell -a &#39;yum -y install libselinux-python&#39;
</code></pre><p>coppy</p>
<pre><code>ansible-playbook copy.yml
</code></pre><p>安装mogilefs</p>
<pre><code>yum install rpm/*.rpm -y
ansible mfs -m shell -a &#39;yum -y install /tmp/rpm/*.rpm&#39;
</code></pre><p>在store node上创建数据存放目录并修改属主</p>
<pre><code>ansible mgs -m shell -a &#39;mkdir -pv /var/mogdata&#39;
ansible mgs -m shell  -a &quot;chown -R mogilefs.mogilefs /var/mogdata&quot;
</code></pre><p>配置tracker</p>
<pre><code>[root@61 ~]# cat /etc/mogilefs/mogilefsd.conf | grep -v &quot;^#&quot;
daemonize = 1
pidfile = /var/run/mogilefsd/mogilefsd.pid
db_dsn = DBI:mysql:mogilefs:host=127.0.0.1  #mysql地址
db_user = mogile
db_pass = password
listen = 127.0.0.1:7001
conf_port = 7001
query_jobs = 10
delete_jobs = 1
replicate_jobs = 5
reaper_jobs = 1
</code></pre><p>mysql相关配置</p>
<pre><code>yum -y install mysql-server
service mysqld start 
mysql&gt;grant all privileges on *.* to mogile@&#39;172.18.50.%&#39; identified by &#39;password&#39;;
mysql&gt;grant all privileges on *.* to mogile@&#39;localhost&#39; identified by &#39;password&#39;;
mysql&gt;flush privileges;
</code></pre><p>初始化数据库,这个过程会自动创建数据库并授权，但是允许的主机为%，不安全，可以在授权完成后修改为指定ip。</p>
<pre><code>mogdbsetup --dbhost=127.0.0.1 --dbpass=password
</code></pre><p>启动mogilefsd</p>
<pre><code>su mogilefs -c &quot;mogilefsd -c /etc/mogilefs/mogilefsd.conf --daemon&quot;
</code></pre><p>启动mogstored并检查是否启动成功</p>
<pre><code>ansible mgs -m shell -a &#39;mogstored -daemon&#39;
[root@61 ~]# ansible mgs -m shell -a &quot;ss -ntl&quot;
172.18.50.62 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port 
LISTEN     0      128                       *:7500                     *:*     
LISTEN     0      128                       *:7501                     *:*     
LISTEN     0      128                      :::22                      :::*     
LISTEN     0      128                       *:22                       *:*     
LISTEN     0      100                     ::1:25                      :::*     
LISTEN     0      100               127.0.0.1:25                       *:*     

172.18.50.64 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port 
LISTEN     0      128                       *:7500                     *:*     
LISTEN     0      128                       *:7501                     *:*     
LISTEN     0      128                      :::22                      :::*     
LISTEN     0      128                       *:22                       *:*     
LISTEN     0      100                     ::1:25                      :::*     
LISTEN     0      100               127.0.0.1:25                       *:*     

172.18.50.63 | SUCCESS | rc=0 &gt;&gt;
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port 
LISTEN     0      128                       *:7500                     *:*     
LISTEN     0      128                       *:7501                     *:*     
LISTEN     0      128                      :::22                      :::*     
LISTEN     0      128                       *:22                       *:*     
LISTEN     0      100                     ::1:25                      :::*     
LISTEN     0      100               127.0.0.1:25                       *:*
</code></pre><p>添加host</p>
<pre><code>mogadm host add node1 --ip=172.18.50.62 --port=7500 --status=alive
mogadm host add node2 --ip=172.18.50.63 --port=7500 --status=alive
mogadm host add node3 --ip=172.18.50.64 --port=7500 --status=alive
</code></pre><p>添加device，这里需要在三台store node的数据目录分别建立dev1-3</p>
<pre><code>mogadm device add node1 1
mogadm device add node2 2
mogadm device add node3 3
</code></pre><p>查看空间是否正常，如果没空间，一般是iptables或文件权限问题</p>
<pre><code>[root@61 ~]# mogadm  device list
node1 [1]: alive
                    used(G)    free(G)   total(G)  weight(%)
   dev1:   alive      1.104     10.923     12.027        100

node2 [2]: alive
                    used(G)    free(G)   total(G)  weight(%)
   dev2:   alive      1.132     10.896     12.027        100

node3 [3]: alive
                    used(G)    free(G)   total(G)  weight(%)
   dev3:   alive      1.132     10.896     12.027        100
</code></pre><p>添加images</p>
<pre><code>mogadm domain add images
mogadm domian add file
</code></pre><p>添加class,这里可以用 –mindevcount=i 指定上传文件的mindevcount</p>
<pre><code>mogadm class add images png
mogadm class add images png
</code></pre><p>上传文件</p>
<pre><code>[root@61 ~]# mogupload  --trackers=127.0.0.1 --domain=images --key=&#39;test.jpg&#39; --file=&#39;/usr/share/backgrounds/simple_waves.jpg&#39;
[root@61 ~]# mogfileinfo --trackers=127.0.0.1 --domain=images --key=&#39;test.jpg&#39; 
- file: test.jpg
     class:              default
  devcount:                    2
    domain:               images
       fid:                    5
       key:             test.jpg
    length:               931957
 - http://172.18.50.63:7500/dev2/0/000/000/0000000005.fid
 - http://172.18.50.64:7500/dev3/0/000/000/0000000005.fid
</code></pre><p>####使用Nginx 做为 MogileFS 的前端客户端<br>这里使用nginx1.10.3</p>
<pre><code>tar -xvf nginx-1.10.3.tar.gz
yum -y install git pcre-devel openssl-devel
git clone https://github.com/vkholodkov/nginx-mogilefs-module.git
cd nginx.1.10.3
 ./configure   --prefix=/usr   --sbin-path=/usr/sbin/nginx   --conf-path=/etc/nginx/nginx.conf   --error-log-path=/var/log/nginx/error.log   --http-log-path=/var/log/nginx/access.log   --pid-path=/var/run/nginx/nginx.pid    --lock-path=/var/lock/nginx.lock   --user=nginx   --group=nginx   --with-http_ssl_module   --with-http_flv_module   --with-http_stub_status_module   --with-http_gzip_static_module   --http-client-body-temp-path=/var/tmp/nginx/client/   --http-proxy-temp-path=/var/tmp/nginx/proxy/   --http-fastcgi-temp-path=/var/tmp/nginx/fcgi/   --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi   --http-scgi-temp-path=/var/tmp/nginx/scgi   --with-pcre   --with-debug   --add-module=/root/nginx-mogilefs-module
make &amp;&amp; make install
有些版本make不成功可以使用make CFLAGS=&quot;-pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -g&quot;
</code></pre><p>这nginx配置文件中加入location进行反代</p>
<pre><code>vim /etc/nginx/nginx.conf
        location /imgs/ {
            mogilefs_tracker 127.0.0.1:7001;
            mogilefs_domain images;
#           mogilefs_class png jpg;

            mogilefs_pass {
                proxy_pass $mogilefs_path;
                proxy_hide_header Content-Type;
                proxy_buffering off;
            }
        }
</code></pre><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><hr>
<p><img src="http://omsab2via.bkt.clouddn.com/mogilefs.png" alt="enter image description here"></p>
<p>最后附几个unit脚本<br>nginx</p>
<pre><code>#!/bin/sh
#
# nginx - this script starts and stops the nginx daemon
#
# chkconfig:   - 85 15 
# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \
#               proxy and IMAP/POP3 proxy server
# processname: nginx
# config:      /etc/nginx/nginx.conf
# config:      /etc/sysconfig/nginx
# pidfile:     /var/run/nginx.pid

# Source function library.
. /etc/rc.d/init.d/functions

# Source networking configuration.
. /etc/sysconfig/network

# Check that networking is up.
[ &quot;$NETWORKING&quot; = &quot;no&quot; ] &amp;&amp; exit 0

nginx=&quot;/usr/sbin/nginx&quot;
prog=$(basename $nginx)

NGINX_CONF_FILE=&quot;/etc/nginx/nginx.conf&quot;

[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx

lockfile=/var/lock/subsys/nginx

make_dirs() {
   # make required directories
   user=`nginx -V 2&gt;&amp;1 | grep &quot;configure arguments:&quot; | sed &#39;s/[^*]*--user=\([^ ]*\).*/\1/g&#39; -`
   options=`$nginx -V 2&gt;&amp;1 | grep &#39;configure arguments:&#39;`
   for opt in $options; do
       if [ `echo $opt | grep &#39;.*-temp-path&#39;` ]; then
           value=`echo $opt | cut -d &quot;=&quot; -f 2`
           if [ ! -d &quot;$value&quot; ]; then
               # echo &quot;creating&quot; $value
               mkdir -p $value &amp;&amp; chown -R $user $value
           fi
       fi
   done
}

start() {
    [ -x $nginx ] || exit 5
    [ -f $NGINX_CONF_FILE ] || exit 6
    make_dirs
    echo -n $&quot;Starting $prog: &quot;
    daemon $nginx -c $NGINX_CONF_FILE
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; touch $lockfile
    return $retval
}

stop() {
    echo -n $&quot;Stopping $prog: &quot;
    killproc $prog -QUIT
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile
    return $retval
}

restart() {
    configtest || return $?
    stop
    sleep 1
    start
}

reload() {
    configtest || return $?
    echo -n $&quot;Reloading $prog: &quot;
    killproc $nginx -HUP
    RETVAL=$?
    echo
}

force_reload() {
    restart
}

configtest() {
  $nginx -t -c $NGINX_CONF_FILE
}

rh_status() {
    status $prog
}

rh_status_q() {
    rh_status &gt;/dev/null 2&gt;&amp;1
}

case &quot;$1&quot; in
    start)
        rh_status_q &amp;&amp; exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart|configtest)
        $1
        ;;
    reload)
        rh_status_q || exit 7
        $1
        ;;
    force-reload)
        force_reload
        ;;
    status)
        rh_status
        ;;
    condrestart|try-restart)
        rh_status_q || exit 0
            ;;
    *)
        echo $&quot;Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}&quot;
        exit 2
esac
</code></pre><p>mogstored</p>
<pre><code>#!/bin/bash
#
# mogstored - Startup script for the MogileFS storage
#
# chkconfig: - 86 14
# description: MogileFS storage 
# processname: mogstored
# config: /etc/mogilefs/mogstored.conf 
# pidfile: /var/run/mogilefsd/mogstored.pid

# Source function library.
. /etc/rc.d/init.d/functions

# Path to the apachectl script, server binary, and short-form for messages.
lockfile=${LOCKFILE-/var/lock/subsys/mogstored} 
RETVAL=0

configfile=&#39;/etc/mogilefs/mogstored.conf&#39;

prog=$(which mogstored)

start() { 
    ulimit -n 65535
    echo -n $&quot;Starting mogstored&quot;
    su - mogilefs -c &quot;$prog -c $configfile --daemon&quot;  &amp;&gt; /dev/null
    RETVAL=$?
    [ $RETVAL = 0 ] &amp;&amp; success &amp;&amp; touch ${lockfile} || failure
    echo
    return $RETVAL
}

stop() {
    echo -n $&quot;Stopping mogstored&quot; 
    netstat -nlp|grep &quot;mogstored&quot;|grep -v grep|awk &#39;{print $7}&#39;|awk -F&quot;/&quot; &#39;{print $1}&#39;|xargs kill -9 
    RETVAL=$?
    [ $RETVAL = 0 ] &amp;&amp; success &amp;&amp; rm -f ${lockfile} || failure
    echo
}

reload() {
    echo -n $&quot;Reloading mogstored: &quot; 
    killall mogstored -HUP 
    RETVAL=$?
    [ $RETVAL = 0 ] &amp;&amp; success || failure
    echo
}

case &quot;$1&quot; in
    start) 
        start
        ;; 
    stop)
        stop
        ;; 
    status) 
        status mogstored 
        RETVAL=$?
        ;;
    restart)
        stop
        sleep 1
        start
        ;;
    reload)
        reload
        ;; 
    *) 
        echo $&quot;Usage: mogstored {start|stop|restart|reload|status}&quot; 
        exit 1
esac
exit $RETVAL
</code></pre><p>mogilefsd服务脚本：</p>
<pre><code>#!/bin/bash
#
# mogilefsd - Startup script for the MogileFS tracker
#
# chkconfig: - 85 15
# description: MogileFS tracker 
# processname: mogilefsd
# config: /etc/mogilefs/mogilefsd.conf 
# pidfile: /var/run/mogilefsd/mogilefsd.pid

# Source function library.
. /etc/rc.d/init.d/functions

# Path to the apachectl script, server binary, and short-form for messages.
lockfile=${LOCKFILE-/var/lock/subsys/mogilefsd} 
RETVAL=0

prog=$(which mogilefsd)

start() { 
    ulimit -n 65535
    echo -n $&quot;Starting mogilefsd&quot;
    su - mogilefs -c &quot;$prog -c /etc/mogilefs/mogilefsd.conf --daemon&quot; 
    RETVAL=$?
    [ $RETVAL = 0 ] &amp;&amp; success &amp;&amp; touch ${lockfile} || failure
    echo
    return $RETVAL
}

stop() {
    echo -n $&quot;Stopping mogilefsd&quot; 
    netstat -nlp|grep &quot;mogilefsd&quot;|grep -v grep|awk &#39;{print $7}&#39;|awk -F&quot;/&quot; &#39;{print $1}&#39;|xargs kill -9 
    RETVAL=$?
    [ $RETVAL = 0 ] &amp;&amp; success &amp;&amp; rm -f ${lockfile} || failure
    echo
}

reload() {
    echo -n $&quot;Reloading mogilefsd: &quot; 
    killall mogilefsd -HUP 
    RETVAL=$?
    [ $RETVAL = 0 ] &amp;&amp; success || failure
    echo
}

case &quot;$1&quot; in
    start) 
        start
        ;; 
    stop)
        stop
        ;; 
    status) 
        status mogilefsd 
        RETVAL=$?
        ;;
    restart)
        stop
        sleep 1
        start
        ;;
    reload)
        reload
        ;; 
    *) 
        echo $&quot;Usage: mogilefsd {start|stop|restart|reload|status}&quot; 
        exit 1
esac
exit $RETVAL
</code></pre><p>####另外的两种安装方式</p>
<pre><code># yum -y install make gcc unzip perl-DBD-MySQL perl perl-CPAN perl-YAML perl-Time-HiRes
# cpan 
App::cpanminus 
MogileFS::Server 
MogileFS::Utils 
IO::AIO 
IO::WrapTie 
Danga::Socket
#2
cpanm安装
wget http://xrl.us/cpanm -O /usr/bin/cpanm; sudo chmod +x /usr/bin/cpanm
#cpanm DBD::mysql
#cpanm MogileFS::Server
#cpanm MogileFS::Utils
#cpanm MogileFS::Client
# cpan -i App::cpanminus
cpan&gt; install App:cpanminus
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/06/12/MogileFS的安装配置/" data-id="cjb05oymp00079fzu8jzb3rfl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MogileFS/">MogileFS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Maradb主从复制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/12/Maradb主从复制/" class="article-date">
  <time datetime="2017-06-12T13:28:08.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/Maradb主从复制/">Maradb主从复制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Maradb主从复制"><a href="#Maradb主从复制" class="headerlink" title="Maradb主从复制"></a>Maradb主从复制</h2><h4 id="MASTER-172-18-50-72"><a href="#MASTER-172-18-50-72" class="headerlink" title="MASTER(172.18.50.72)"></a>MASTER(172.18.50.72)</h4><p>vim /etc/my.cnf.d/server.cnf添加</p>
<pre><code>innodb_file_per_table=ON
skip_name_resolve=ON
log_bin=mysql-bin
server_id=1
</code></pre><p>授权slave服务器</p>
<pre><code>GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO test@&#39;172.18.50.73&#39; IDENTIFIED BY &#39;test123&#39;;
</code></pre><p>查看二进制文件</p>
<pre><code>MariaDB [(none)]&gt; SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000005 |      503 |              |                  |
+------------------+----------+--------------+------------------+
MariaDB [(none)]&gt; SHOW BINARY LOGS;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |       288 |
| mysql-bin.000002 |       848 |
| mysql-bin.000003 |      1629 |
| mysql-bin.000004 |       811 |
| mysql-bin.000005 |       503 |
+------------------+-----------+
5 rows in set (0.00 sec)
</code></pre><h4 id="SLAVE-172-18-50-73"><a href="#SLAVE-172-18-50-73" class="headerlink" title="SLAVE(172.18.50.73)"></a>SLAVE(172.18.50.73)</h4><p>在/etc/my.cnf.d/server.cnf中加入</p>
<pre><code>[mysqld]
skip_name_resolve=ON
innodb_file_per_table=ON
server_id=2
relay_log=relay-log
</code></pre><p>授权</p>
<pre><code>CHANGE MASTER TO MASTER_HOST=&#39;172.18.50.72&#39;,MASTER_USER=&#39;test&#39;,MASTER_PASSWORD=&#39;test123&#39;,MASTER_LOG_FILE=&#39;mysql-bin.000005&#39;,MASTER_LOG_POS=503;
</code></pre><p>启动slave,IO和SQL为Yes说明启动成功</p>
<pre><code>START SLAVE;
SHOW SLAVE STATUS\G
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
</code></pre><p> <strong>复制时需要注意的地方：</strong></p>
<ol>
<li><p>从服务应该设定为只读<br>在从服务器启动read_only,但对非SUPER权限的用户有效；</p>
<pre><code>show global variables like &quot;%read_only%&quot;;    
MariaDB [(none)]&gt; SET @@GLOBAL.read_only=ON;
</code></pre><pre><code>阻止所有用户
</code></pre><pre><code>MariaDB [(none)]&gt; FLUSH TABLES WITH READ LOCK;
Query OK, 0 rows affected (0.00 sec)
</code></pre></li>
<li><p>尽量确保复制时的事务安全<br>在master节点启用参数</p>
<pre><code>MariaDB [(none)]&gt; set @@global.sync_binlog=1;
</code></pre><p>如果是Innodb存储引擎,确保下面两项是on状态</p>
<pre><code>  MariaDB [(none)]&gt; show variables like &#39;innodb%trx%&#39;;
  +-------------------------------------------+-------+
  | Variable_name                             | Value |
  +-------------------------------------------+-------+
  | innodb_flush_log_at_trx_commit            | 1     |
  | innodb_use_global_flush_log_at_trx_commit | ON    |
  +-------------------------------------------+-------+
</code></pre></li>
<li>从服务器意外终止时尽量避免自动启动复制线程</li>
<li><p>从节点：设置参数</p>
<pre><code>MariaDB [(none)]&gt; set @@global.sync_master_info=1;
MariaDB [(none)]&gt; set @@global.sync_master_info=ON
</code></pre><p>​</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/06/12/Maradb主从复制/" data-id="cjb05oymk00039fzuxyoayeq4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mariadb/">Mariadb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/主从复制/">主从复制</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ProxySQL1.3.6配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/12/ProxySQL1.3.6配置/" class="article-date">
  <time datetime="2017-06-12T13:28:08.000Z" itemprop="datePublished">2017-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/12/ProxySQL1.3.6配置/">ProxySQL1.3.6配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ProxySQL1-3-6配置"><a href="#ProxySQL1-3-6配置" class="headerlink" title="ProxySQL1.3.6配置"></a>ProxySQL1.3.6配置</h3><p><strong>下载</strong><br><a href="https://github.com/sysown/proxysql/releases" target="_blank" rel="noopener">https://github.com/sysown/proxysql/releases</a></p>
<h4 id="ProxySQL配置"><a href="#ProxySQL配置" class="headerlink" title="ProxySQL配置"></a>ProxySQL配置</h4><pre><code>[root@171 ~]# cat /etc/proxysql.cnf | grep -E -v &quot;^(#|$)&quot;
datadir=&quot;/var/lib/proxysql&quot;
admin_variables=
{
    admin_credentials=&quot;admin:admin&quot;
    mysql_ifaces=&quot;127.0.0.1:6032;/tmp/proxysql_admin.sock&quot;
}
mysql_variables=
{
    threads=4
    max_connections=2048
    default_query_delay=0
    default_query_timeout=36000000
    have_compress=true
    poll_timeout=2000
    interfaces=&quot;0.0.0.0:3306;/tmp/mysql.sock&quot;
    default_schema=&quot;information_schema&quot;
    stacksize=1048576
    server_version=&quot;5.5.30&quot;
    connect_timeout_server=3000
    monitor_history=600000
    monitor_connect_interval=60000
    monitor_ping_interval=10000
    monitor_read_only_interval=1500
    monitor_read_only_timeout=500
    ping_interval_server=120000
    ping_timeout_server=500
    commands_stats=true
    sessions_sort=true
    connect_retries_on_failure=10
}
mysql_servers =
(
    {
        address = &quot;172.18.50.71&quot; # no default, required . If port is 0 , address is interpred as a Unix Socket Domain
        port = 3306           # no default, required . If port is 0 , address is interpred as a Unix Socket Domain
        hostgroup = 0            # no default, required
        status = &quot;ONLINE&quot;     # default: ONLINE
        weight = 1            # default: 1
        compression = 0       # default: 0
    },
    {
        address = &quot;172.18.50.72&quot;
        port = 3306
        hostgroup = 1
        status = &quot;ONLINE&quot;
        weight = 1       
        compression = 0  
    },
    {
        address = &quot;172.18.50.73&quot;
        port = 3306
        hostgroup = 1
        status = &quot;ONLINE&quot;
        weight = 1   
        compression = 0  
    }
)
mysql_users:
(
    {
        username = &quot;root&quot;
        password = &quot;rootpw&quot;
        default_hostgroup = 0
        max_connections=1000
        default_schema=&quot;mytest&quot;
        active = 1
    },
    {
        username = &quot;root&quot;
        password = &quot;rootpw&quot;
        default_hostgroup = 1
        max_connections=1000
        default_schema=&quot;mytest&quot;
        active = 1
    }
)
mysql_query_rules:
(
)
scheduler=
(
)
mysql_replication_hostgroups=
(
        {
                writer_hostgroup=0
                reader_hostgroup=1
       }
)
</code></pre><p>MASTER</p>
<pre><code>#授权
grant all on *.*  to  root@&#39;proxysql ip&#39; identified by &#39;rootpw&#39;;
</code></pre><p>MASTER授权从服务器会同步授权<br>测试<br>分别在两台从服务器添加不同的表,并测试</p>
<pre><code>[root@171 ~]# mysql -uroot -prootpw -h172.18.50.170 -e &quot;select * from mytest.t1&quot;;
+--------+
| name   |
+--------+
| slave2 |
+--------+
[root@171 ~]# mysql -uroot -prootpw -h172.18.50.170 -e &quot;select * from mytest.t1&quot;;
+-------+
| name  |
+-------+
| slave |
+-------+
[root@171 ~]# mysql -uroot -prootpw -h172.18.50.170 -e &quot;select * from mytest.t1&quot;;
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/06/12/ProxySQL1.3.6配置/" data-id="cjb05oymr000a9fzu2akp3j0q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ProxySQL/">ProxySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中间件/">中间件</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-http_header" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/25/http_header/" class="article-date">
  <time datetime="2017-05-25T07:30:49.000Z" itemprop="datePublished">2017-05-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/HTTP-HEADER/">HTTP HEADER</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/25/http_header/">HTTP HEADER</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="HTTP-HEADER"><a href="#HTTP-HEADER" class="headerlink" title="HTTP HEADER"></a>HTTP HEADER</h4><ul>
<li>Accept-Ranges：表明服务器是否支持指定范围请求及那种类型的分段请求</li>
<li>Age：从原始服务器到代理缓存形成的估算时间</li>
<li>Allow：对某网络资源的有效请求行为，不允许则返回405</li>
<li>Cache-Contril：告诉所有的缓存机制是否可以缓存及哪种类型</li>
<li>Content-Encoding：web服务器支持返回内容压缩编码类型</li>
<li>Content-Language：响应体的语言</li>
<li>Content-Length：响应体的长度</li>
<li>Content-Location：请求资源可替代的备用的另一地址</li>
<li>Content-MD5：返回资源的MD5校验值</li>
<li>Content-Range：在整个返回体中本部分的字节位置</li>
<li>Centent-Type：返回内容的MIME类型</li>
<li>Date：原始服务器消息发出的时间</li>
<li>ETag：请求变量的实体标签的当前值</li>
<li>Expires：响应过期的日期和时间</li>
<li>Last-Modified：请求资源的最后修改时间</li>
<li>Location：用来重定向接收方到非请求URL的位置来完成请求或标识新的资源</li>
<li>Pragma：包括实现特定的指令，他可应用呢到响应链上的任何接收方</li>
<li>Proxy-Authenticte：它指出认证方案可应用到代理的该URL上的参数</li>
<li>refresh：应用于重定向或一个新的资源被创造，在5秒之后重定向</li>
<li>Retry-After：如果实体暂时不可取，通知客户端在指定时间之后再次尝试</li>
<li>Server：web服务器软件名称</li>
<li>Set-Cookie：设置Http Cookie</li>
<li>Trailer：指出头域在分块传输编码的尾部存在</li>
<li>Transfer-Encoding：文件传输编码</li>
<li>Vary：告诉下游代理是使用缓存响应 还是从原始服务器请求</li>
<li>Via：告知代理客户端响应是通过哪里发送的</li>
<li>Warning：警告实体可能存在的问题</li>
<li>WWW-Authenticate：表面客户端请求实体应该使用的授权方案</li>
</ul>
<p><strong>HTTP Request的Header信息</strong></p>
<ol>
<li><p>Http请求方式</p>
<p>GET    向服务器请求一个文件</p>
<p>POST    向WEB服务器发送数据让WEB服务器进行处理</p>
<p>PUT    向WEB服务器发送数据并存储在WEB服务器内部</p>
<p>HEAD    检查一个对象是否存在</p>
<p>DELNET    从服务器删除一个文件</p>
<p>CONNECT    对通道提供支持</p>
<p>TRACE    跟踪到服务器的路径</p>
<p>OPTIONS    查询Web服务器的性能</p>
</li>
<li><p>Host</p>
<p>请求的web服务器域名地址</p>
</li>
<li><p>User-Agent</p>
<p>HTTP客户端运行的浏览器类型的详细信息。通过该头部信息，web服务器可以判断到当前Http请求的客户端浏览器类别</p>
</li>
<li><p>Accept</p>
<p>指明客户端能够接受的内容类型，内容类型中的先后次序表示客户端接收的先后次序。</p>
</li>
<li><p>Accept-Language</p>
<p>指明Http客户端浏览器用来展示返回信息所优先选择的语言</p>
</li>
<li><p>Accept-Encoding</p>
<p>指定客户端浏览器可以支持的web浏览器返回内容压缩编码类型。表示允许服务器在将输出内容发送到客户端以前进行压缩，以节约带宽。这里设置的就是客户端浏览器所能够支持的返回压缩格式</p>
<p>​    Accept-Encoding: gzip,deflate</p>
</li>
<li><p>Accept-Charset</p>
<p>浏览器可以接受的字符编码集</p>
</li>
<li><p>Content-Type</p>
<p>显示此HTTP请求提交的内容类型。一般只有post提交时才需要设置该属性。</p>
</li>
<li><p>Connection</p>
<p>表示是否需要持久连接。如果web服务器端看到这里的值为”Keep-Alive”,或者看到请求使用的是HTTP 1.1(HTTP 1.1默认进行持久连接)，它就可以利用持久连接的优点，当页面包含多个元素时(例如Applet，图片)，显著地减少下载所需要的时间。要实现这一点，web服务器需要在返回客户端HTTP头信息中发送一个Content-Length(返回信息正文的长度)头，最简单的实现方法是：先把内容写入ByteArrayOutputStream，然后在正式写出内容之前计算它的大小。</p>
</li>
<li><p>Keep-Alive</p>
<p>显示此HTTP连接的Keep-Alive时间。示客户端到服务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive功能避免了建立或者重新建立连接。</p>
<p>从HTTP/1.1协议之后，就有了长连接，即在规定的Keep-Alive时间内，连接是不会断开的。</p>
</li>
<li><p>cookie</p>
<p>HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发往给web服务器。</p>
</li>
<li><p>包含一个URL,用户从该URL代表的页面出发访问当前请求的页面</p>
</li>
</ol>
<p><strong>服务器返回HTTP头部信息</strong></p>
<ol>
<li><p>Content-Length</p>
<p>表示web服务器返回消息正文的长度</p>
</li>
<li><p>Content-Type</p>
<p>返回数据的类型</p>
</li>
<li><p>Date</p>
<p>显示当前时间</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/05/25/http_header/" data-id="cjb05oyn2000w9fzuq0256zzt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP-HEADER/">HTTP HEADER</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Tomcat session共享" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/25/Tomcat session共享/" class="article-date">
  <time datetime="2017-05-25T07:30:49.000Z" itemprop="datePublished">2017-05-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tomcat/">Tomcat</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/25/Tomcat session共享/">Tomcat session共享</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Tomcat-session共享"><a href="#Tomcat-session共享" class="headerlink" title="Tomcat session共享"></a>Tomcat session共享</h2><p>通过memcached-session-manager实现，项目地址<a href="https://github.com/magro/memcached-session-manager，实验拓扑如下：" target="_blank" rel="noopener">https://github.com/magro/memcached-session-manager，实验拓扑如下：</a><br><img src="http://omsab2via.bkt.clouddn.com/session.png" alt="enter image description here"></p>
<h3 id="50-71"><a href="#50-71" class="headerlink" title="50.71"></a>50.71</h3><p>安装配置ansible</p>
<pre><code>yum -y install ansible

vim /etc/ansible/hosts
#加入
[tcs]
172.18.50.72
172.18.50.73
[mems]
172.18.50.61
172.18.50.62
#生成key并copy至tcs及mems
ssh-keygen 
ssh-copy-id root@172.18.50.72
ssh-copy-id root@172.18.50.73
ssh-copy-id root@172.18.50.61
ssh-copy-id root@172.18.50.62
ansible all -m ping
</code></pre><p>关闭防火墙及selink</p>
<pre><code>[root@71 ansible]# ansible all -m shell -a &#39;iptables -F;setenforce 0&#39;
172.18.50.61 | SUCCESS | rc=0 &gt;&gt;


172.18.50.72 | SUCCESS | rc=0 &gt;&gt;


172.18.50.73 | SUCCESS | rc=0 &gt;&gt;


172.18.50.62 | SUCCESS | rc=0 &gt;&gt;
</code></pre><p><strong>同步时间</strong></p>
<pre><code> cat /etc/ansible/ntp.yml 

- hosts: all
  remote_user: root
  tasks:
  - name: install ntp
    yum: name=ntp state=latest
  - name: sync time
    shell: ntpdate ntp1.aliyun.com

[root@71 ~]# ansible-playbook /etc/ansible/ntp.yml
#查看是否同步
[root@71 ~]# ansible all -m shell -a &#39;date&#39;
172.18.50.61 | SUCCESS | rc=0 &gt;&gt;
Thu May 25 10:49:24 CST 2017

172.18.50.62 | SUCCESS | rc=0 &gt;&gt;
Thu May 25 10:49:25 CST 2017

172.18.50.73 | SUCCESS | rc=0 &gt;&gt;
Thu May 25 10:49:25 CST 2017

172.18.50.72 | SUCCESS | rc=0 &gt;&gt;
Thu May 25 10:49:25 CST 2017
</code></pre><p><strong>安装tomcat</strong></p>
<pre><code>[root@71 ansible]# cat tomcat.yml 
---

- hosts: tcs
  remote_user: root
  tasks:
  - name: install tomcat
    yum: name=tomcat,tomcat-webapps  state=latest
  - name: start tomcat
    service: name=tomcat state=started
[root@71 ansible]# ansible-playbook tomcat.yml
</code></pre><p><strong>安装memcached</strong></p>
<pre><code>[root@71 ~]# cat /etc/ansible/mems.yml 
---

- hosts: mems
  remote_user: root
  tasks:
  - name: install memcached
    yum: name=memcached state=latest
  - name: start memcached
    service: name=memcached state=started
[root@71 ~]# ansible-playbook /etc/ansible/mems.yml
</code></pre><p>安装httpd并实现负载均衡</p>
<pre><code>yum -y install httpd
#在conf/httpd.conf中插入
&lt;Proxy balancer://tomcat&gt;
    BalancerMember  http://172.18.50.72:8080 loadfactor=1
    BalancerMember  http://172.18.50.73:8080 loadfactor=1
    ProxySet  lbmethod=byrequests
&lt;/Proxy&gt;
ProxyVia Off
ProxyRequests Off
ProxyPass / balancer://tomcat/
ProxyPassReverse / balancer://tomcat/
&lt;Proxy *&gt;
    Order Allow,Deny
    Allow From all
&lt;/Proxy&gt;
&lt;Location /&gt;
    Order Allow,Deny
    Allow From all
&lt;/Location&gt;
</code></pre><h4 id="安装配置-memcached-session-manager"><a href="#安装配置-memcached-session-manager" class="headerlink" title="安装配置 memcached-session-manager"></a>安装配置 memcached-session-manager</h4><ul>
<li>下载jar文件<pre><code>下载如下jar文件至各tomcat节点的tomcat安装目录下的lib目录中，其中的${version}要换成你所需要的版本号，tc${6,7,8}要换成与tomcat版本相同的版本号。
  memcached-session-manager-${version}.jar
  memcached-session-manager-tc${6,7,8}-${version}.jar
  spymemcached-${version}.jar
  msm-javolution-serializer-${version}.jar
  javolution-${version}.jar
</code></pre></li>
<li>使用ansible推送至tcs<br>```<br>[root@71 ~]# ls<br>anaconda-ks.cfg  javolution-5.4.3.1.jar               memcached-session-manager-tc7-1.8.3.jar  spymemcached-2.11.1.jar<br>copy_jar.yml     memcached-session-manager-1.8.3.jar  msm-javolution-serializer-1.8.3.jar<br>[root@71 ~]# cat copy_jar.yml </li>
</ul>
<hr>
<ul>
<li>hosts: tcs<br>remote_user: root<br>tasks:<ul>
<li>name: copy jar to tcs<br>copy: src=~/ dest=/usr/share/tomcat/lib<br>with_items:<ul>
<li>“memcached-session-manager-tc7-1.8.3.jar”</li>
<li>“javolution-5.4.3.1.jar”</li>
<li>“memcached-session-manager-1.8.3.jar”</li>
<li>“spymemcached-2.11.1.jar”</li>
<li>“msm-javolution-serializer-1.8.3.jar”</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>**配置tomcat1**
tomcat2配置与1除测试页外一致
</code></pre><p>mkdir -pv /usr/share/tomcat/webapps/test/{classes,lib,WEB-INF}<br>cat /usr/share/tomcat/test/webapps/test/index.jsp<br>&lt;%@ page language=”java” %&gt;</p>
<p><html><br>  <head><title>TomcatB</title></head><br>  <body><br>    <h1><font color="blue">TomcatB</font></h1><br>    <table align="centre" border="1"><br>      <tr><br>        <td>Session ID</td><br>    &lt;% session.setAttribute(“test.com”,”test.com”); %&gt;<br>        <td>&lt;%= session.getId() %&gt;</td><br>      </tr><br>      <tr><br>        <td>Created on</td><br>        <td>&lt;%= session.getCreationTime() %&gt;</td><br>     </tr><br>    </table><br>  </body><br></html><br>[root@73 test]# cat /etc/tomcat/server.xml<br>&lt;?xml version=’1.0’ encoding=’utf-8’?&gt;<br>&lt;!–<br>  Licensed to the Apache Software Foundation (ASF) under one or more<br>  contributor license agreements.  See the NOTICE file distributed with<br>  this work for additional information regarding copyright ownership.<br>  The ASF licenses this file to You under the Apache License, Version 2.0<br>  (the “License”); you may not use this file except in compliance with<br>  the License.  You may obtain a copy of the License at</p>
<pre><code>  http://www.apache.org/licenses/LICENSE-2.0
</code></pre><p>  Unless required by applicable law or agreed to in writing, software<br>  distributed under the License is distributed on an “AS IS” BASIS,<br>  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br>  See the License for the specific language governing permissions and<br>  limitations under the License.<br>–&gt;<br><!-- Note:  A "Server" is not itself a "Container", so you may not
     define subcomponents such as "Valves" at this level.
     Documentation at /docs/config/server.html
 --></p>
<server port="8005" shutdown="SHUTDOWN"><br>  <listener classname="org.apache.catalina.startup.VersionLoggerListener"><br>  <!-- Security listener. Documentation at /docs/config/listeners.html
  <Listener className="org.apache.catalina.security.SecurityListener" />
  --><br>  <!--APR library loader. Documentation at /docs/apr.html --><br>  <listener classname="org.apache.catalina.core.AprLifecycleListener" sslengine="on"><br>  <!--Initialize Jasper prior to webapps are loaded. Documentation at /docs/jasper-howto.html --><br>  <listener classname="org.apache.catalina.core.JasperListener"><br>  <!-- Prevent memory leaks due to use of particular java/javax APIs--><br>  <listener classname="org.apache.catalina.core.JreMemoryLeakPreventionListener"><br>  <listener classname="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"><br>  <listener classname="org.apache.catalina.core.ThreadLocalLeakPreventionListener"><br><br>  <!-- Global JNDI resources
       Documentation at /docs/jndi-resources-howto.html
  --><br>  <globalnamingresources><br>    <!-- Editable user database that can also be used by
         UserDatabaseRealm to authenticate users
    --><br>    <resource name="UserDatabase" auth="Container" type="org.apache.catalina.UserDatabase" description="User database that can be updated and saved" factory="org.apache.catalina.users.MemoryUserDatabaseFactory" pathname="conf/tomcat-users.xml"><br>  </resource></globalnamingresources><br><br>  <!-- A "Service" is a collection of one or more "Connectors" that share
       a single "Container" Note:  A "Service" is not itself a "Container",
       so you may not define subcomponents such as "Valves" at this level.
       Documentation at /docs/config/service.html
   --><br>  <service name="Catalina"><br><br>    <!--The connectors can use a shared executor, you can define one or more named thread pools--><br>    <!--
    <Executor name="tomcatThreadPool" namePrefix="catalina-exec-"
        maxThreads="150" minSpareThreads="4"/>
    --><br><br><br>    <!-- A "Connector" represents an endpoint by which requests are received
         and responses are returned. Documentation at :
         Java HTTP Connector: /docs/config/http.html (blocking & non-blocking)
         Java AJP  Connector: /docs/config/ajp.html
         APR (HTTP/AJP) Connector: /docs/apr.html
         Define a non-SSL HTTP/1.1 Connector on port 8080
    --><br>    <connector port="8080" protocol="HTTP/1.1" connectiontimeout="20000" redirectport="8443"><br>    <!-- A "Connector" using the shared thread pool--><br>    <!--
    <Connector executor="tomcatThreadPool"
               port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />
    --><br>    <!-- Define a SSL HTTP/1.1 Connector on port 8443
         This connector uses the BIO implementation that requires the JSSE
         style configuration. When using the APR/native implementation, the
         OpenSSL style configuration is required as described in the APR/native
         documentation --><br>    <!--
    <Connector port="8443" protocol="org.apache.coyote.http11.Http11Protocol"
               maxThreads="150" SSLEnabled="true" scheme="https" secure="true"
               clientAuth="false" sslProtocol="TLS" />
    --><br><br>    <!-- Define an AJP 1.3 Connector on port 8009 --><br>    <connector port="8009" protocol="AJP/1.3" redirectport="8443"><br><br><br>    <!-- An Engine represents the entry point (within Catalina) that processes
         every request.  The Engine implementation for Tomcat stand alone
         analyzes the HTTP headers included with the request, and passes them
         on to the appropriate Host (virtual host).
         Documentation at /docs/config/engine.html --><br><br>    <!-- You should set jvmRoute to support load-balancing via AJP ie :
    <Engine name="Catalina" defaultHost="localhost" jvmRoute="jvm1">
    --><br>    <engine name="Catalina" defaulthost="localhost"><br><br>      <!--For clustering, please take a look at documentation at:
          /docs/cluster-howto.html  (simple how to)
          /docs/config/cluster.html (reference documentation) --><br>      <!--
      <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/>
      --><br><br>      <!-- Use the LockOutRealm to prevent attempts to guess user passwords
           via a brute-force attack --><br>      <realm classname="org.apache.catalina.realm.LockOutRealm"><br>        <!-- This Realm uses the UserDatabase configured in the global JNDI
             resources under the key "UserDatabase".  Any edits
             that are performed against this UserDatabase are immediately
             available for use by the Realm.  --><br>        <realm classname="org.apache.catalina.realm.UserDatabaseRealm" resourcename="UserDatabase"><br>      </realm><br><br>      <host name="localhost" appbase="webapps" unpackwars="true" autodeploy="true"><br><br>        <!-- SingleSignOn valve, share authentication between web applications
             Documentation at: /docs/config/valve.html --><br>        <!--
        <Valve className="org.apache.catalina.authenticator.SingleSignOn" />
        --><br><br>        <!-- Access log processes all example.
             Documentation at: /docs/config/valve.html
             Note: The pattern used is equivalent to using pattern="common" --><br>        <valve classname="org.apache.catalina.valves.AccessLogValve" directory="logs" prefix="localhost_access_log." suffix=".txt" pattern="%h %l %u %t &quot;%r&quot; %s %b"><br>        <context path="/test" docbase="/usr/share/tomcat/webapps/test" reloadable="true"><br>              <manager classname="de.javakaffee.web.msm.MemcachedBackupSessionManager" memcachednodes="n1:172.18.50.61:11211,n2:172.18.50.62:11211" failovernodes="n1" requesturiignorepattern=".*\.(ico|png|gif|jpg|css|js)$" transcoderfactoryclass="de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory"><br>        </manager></context><br>      </valve></host><br>    </realm></engine><br>  </connector></connector></service><br></listener></listener></listener></listener></listener></listener></server>

<p>```<br><strong>测试</strong></p>
<blockquote>
<p><a href="http://172.18.50.71" target="_blank" rel="noopener">http://172.18.50.71</a><br>TomcatA<br>Session ID<br>3F96F6A4657D50881AC523F6A7AF787F-n2<br>Created on<br>1495693301965<br>刷新后为<br>TomcatB<br>Session ID<br>3F96F6A4657D50881AC523F6A7AF787F-n2<br>Created on<br>1495693301965<br>stop n2后为 n1</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/05/25/Tomcat session共享/" data-id="cjb05oyms000c9fzuhuwsld3j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/session/">session</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-web站点的动静分离及高可用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/18/web站点的动静分离及高可用/" class="article-date">
  <time datetime="2017-05-18T08:40:00.000Z" itemprop="datePublished">2017-05-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Haproxy/">Haproxy</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/18/web站点的动静分离及高可用/">web站点的动静分离及高可用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="web站点的动静分离及高可用"><a href="#web站点的动静分离及高可用" class="headerlink" title="web站点的动静分离及高可用"></a>web站点的动静分离及高可用</h3><p><strong>要求</strong>：动静分离部署wordpress，动静都要能实现负载均衡，<img src="http://omsab2via.bkt.clouddn.com/haproxy.png" alt="enter image description here"></p>
<h4 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h4><pre><code>iptables -F
setenforce 0
</code></pre><h4 id="Ca"><a href="#Ca" class="headerlink" title="Ca"></a>Ca</h4><p>生成私钥</p>
<blockquote>
<p>(umask 066;openssl genrsa -out /etc/pki/CA/private/cakey.pem 4096)</p>
</blockquote>
<p>自颁发证书</p>
<blockquote>
<p>cd /etc/pki/CA<br>openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 99999<br>touch /etc/pki/CA/index.txt<br>echo 01 &gt; /etc/pki/CA/serial</p>
</blockquote>
<p>颁发</p>
<blockquote>
<p>opensl ca -in test.csr -out /etc/pki/CA/certs/test.crt -days 365</p>
</blockquote>
<h4 id="Nfs"><a href="#Nfs" class="headerlink" title="Nfs"></a>Nfs</h4><pre><code>yum -y install nfs-utils
vim /etc/exprot
/www 172.18.0.0/16(rw,async)
systemctl start nfs
exportfs -ar
</code></pre><h4 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h4><pre><code>yum -y install mysql-server
create database wp;
grant all privileges on wp.* to wp@&#39;172.18.50.61&#39; by &#39;1234&#39;;
grant all privileges on wp.* to wp@&#39;172.18.50.62&#39; by &#39;1234&#39;;
flush privileges;
</code></pre><h4 id="static端"><a href="#static端" class="headerlink" title="static端"></a>static端</h4><pre><code>yum -y install httpd 
mkdir -v /www
mount -t nfs 172.18.50.73:/www /www
</code></pre><p>记录真实ip需要将httpd的log格式%h改为%{X-Forwarded-For}i，同时haproxy需开启forwardfor这个option</p>
<h4 id="php端"><a href="#php端" class="headerlink" title="php端"></a>php端</h4><pre><code>yum -y install httpd php
service start httpd
mkdir -v /www
mount -t nfs 172.18.50.73:/www /www
</code></pre><p>记录真实ip需要将httpd的log格式%h改为%{X-Forwarded-For}i，同时haproxy需开启forwardfor这个option</p>
<h4 id="Haproxy-1"><a href="#Haproxy-1" class="headerlink" title="Haproxy 1"></a>Haproxy 1</h4><p><strong>申请证书</strong></p>
<ul>
<li>建立私钥并生产申请文件<br>```<br>(umask 077;openssl genrsa -out /etc/pki/tls/private/test.key 1024)<br>cd /etc/pki/tls/private<br>openssl req -new -key test.key -out /etc/pki/tls/test.csr -days 365</li>
</ul>
<pre><code>将申请文件scp到ca端颁发证书
</code></pre><p>mkdir -pv /etc/ssl<br>cat  demo.crt demo.key &gt; demo.pem  #crt后的证书文件要求PEM格式，且同时包含证书和与之匹配的所有私钥；</p>
<pre><code>
</code></pre><p>yum -y install haproxy<br>yum -y install keepalived</p>
<pre><code>
</code></pre><p>[root@71 ~]# cat /etc/haproxy/haproxy.cfg</p>
<p>#———————————————————————</p>
<h1 id="Example-configuration-for-a-possible-web-application-See-the"><a href="#Example-configuration-for-a-possible-web-application-See-the" class="headerlink" title="Example configuration for a possible web application.  See the"></a>Example configuration for a possible web application.  See the</h1><h1 id="full-configuration-options-online"><a href="#full-configuration-options-online" class="headerlink" title="full configuration options online."></a>full configuration options online.</h1><p>#</p>
<h1 id="http-haproxy-1wt-eu-download-1-4-doc-configuration-txt"><a href="#http-haproxy-1wt-eu-download-1-4-doc-configuration-txt" class="headerlink" title="http://haproxy.1wt.eu/download/1.4/doc/configuration.txt"></a><a href="http://haproxy.1wt.eu/download/1.4/doc/configuration.txt" target="_blank" rel="noopener">http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</a></h1><p>#</p>
<p>#———————————————————————</p>
<p>#———————————————————————</p>
<h1 id="Global-settings"><a href="#Global-settings" class="headerlink" title="Global settings"></a>Global settings</h1><p>#———————————————————————<br>global</p>
<pre><code># to have these messages end up in /var/log/haproxy.log you will
# need to:
#
# 1) configure syslog to accept network log events.  This is done
#    by adding the &#39;-r&#39; option to the SYSLOGD_OPTIONS in
#    /etc/sysconfig/syslog
#
# 2) configure local2 events to go to the /var/log/haproxy.log
#   file. A line like the following can be added to
#   /etc/sysconfig/syslog
#
#    local2.*                       /var/log/haproxy.log
#
log         127.0.0.1 local2

chroot      /var/lib/haproxy
pidfile     /var/run/haproxy.pid
maxconn     4000
user        haproxy
group       haproxy
daemon

# turn on stats unix socket
stats socket /var/lib/haproxy/stats
</code></pre><p>#———————————————————————</p>
<h1 id="common-defaults-that-all-the-‘listen’-and-‘backend’-sections-will"><a href="#common-defaults-that-all-the-‘listen’-and-‘backend’-sections-will" class="headerlink" title="common defaults that all the ‘listen’ and ‘backend’ sections will"></a>common defaults that all the ‘listen’ and ‘backend’ sections will</h1><h1 id="use-if-not-designated-in-their-block"><a href="#use-if-not-designated-in-their-block" class="headerlink" title="use if not designated in their block"></a>use if not designated in their block</h1><p>#———————————————————————<br>defaults<br>    mode                    http<br>    log                     global<br>    option                  httplog<br>    option                  dontlognull<br>    option http-server-close<br>    option forwardfor       except 127.0.0.0/8<br>    option                  redispatch<br>    retries                 3<br>    timeout http-request    10s<br>    timeout queue           1m<br>    timeout connect         10s<br>    timeout client          1m<br>    timeout server          1m<br>    timeout http-keep-alive 10s<br>    timeout check           10s<br>    maxconn                 3000</p>
<p>#———————————————————————</p>
<h1 id="main-frontend-which-proxys-to-the-backends"><a href="#main-frontend-which-proxys-to-the-backends" class="headerlink" title="main frontend which proxys to the backends"></a>main frontend which proxys to the backends</h1><p>#———————————————————————<br>frontend  localhost<br>    bind <em>:80<br>    bind </em>:443 ssl crt /etc/ssl/ssl.pem<br>    mode http<br>    redirect scheme https if !{ ssl_fc }</p>
<pre><code>acl url_static       path_end       -i .jpg .gif .png 
use_backend static          if url_static
default_backend dy 
option forwardfor
</code></pre><p>listen stats<br>    bind *:10000<br>    acl admin_src src 172.18.100.7<br>    stats enable<br>    stats uri /haproxy?admin<br>    stats auth admin:admin<br>    block  if ! admin_src</p>
<p>#———————————————————————</p>
<h1 id="static-backend-for-serving-up-images-stylesheets-and-such"><a href="#static-backend-for-serving-up-images-stylesheets-and-such" class="headerlink" title="static backend for serving up images, stylesheets and such"></a>static backend for serving up images, stylesheets and such</h1><p>#———————————————————————<br>backend static<br>    balance     roundrobin<br>    server      static 172.18.50.50:80 check<br>    server      static 172.18.50.73:80 check</p>
<p>#———————————————————————</p>
<h1 id="round-robin-balancing-between-the-various-backends"><a href="#round-robin-balancing-between-the-various-backends" class="headerlink" title="round robin balancing between the various backends"></a>round robin balancing between the various backends</h1><p>#———————————————————————<br>backend dy<br>    balance     roundrobin<br>    server  app1 172.18.50.61:80 check<br>    server  app2 172.18.50.62:80 check</p>
<pre><code>**keepalived**
</code></pre><p>[root@71 ~]# cat /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived</p>
<p>global_defs {<br>   notification_email {<br>     acassen@firewall.loc<br>     failover@firewall.loc<br>     sysadmin@firewall.loc<br>   }<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 192.168.200.1<br>   smtp_connect_timeout 30<br>   router_id LVS_DEVEL<br>   vrrp_mcast_group4 224.0.0.50<br>}</p>
<p>vrrp_instance ha1 {<br>    state MASTER<br>    interface ens33<br>    virtual_router_id 50<br>    priority 100<br>    advert_int 1<br>    authentication {<br>        auth_type PASS<br>        auth_pass password<br>    }<br>    virtual_ipaddress {</p>
<pre><code>172.18.50.71/16 dev ens33

}
</code></pre><p>}</p>
<pre><code>#### Haproxy 2
haproxy 2 proxy配置与 1一致
</code></pre><p>yum install -y haproxy keepalived<br>[root@72 keepalived]# cat /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived</p>
<p>global_defs {<br>   notification_email {<br>     acassen@firewall.loc<br>     failover@firewall.loc<br>     sysadmin@firewall.loc<br>   }<br>   notification_email_from Alexandre.Cassen@firewall.loc<br>   smtp_server 192.168.200.1<br>   smtp_connect_timeout 30<br>   router_id LVS_DEVEL<br>   vrrp_mcast_group4 224.0.0.50<br>}</p>
<p>vrrp_instance ha1 {<br>    state BACKUP<br>    interface ens33<br>    virtual_router_id 50<br>    priority 98<br>    advert_int 1<br>    authentication {<br>        auth_type PASS<br>        auth_pass password<br>    }<br>    virtual_ipaddress {</p>
<pre><code>172.18.50.71/16 dev ens33

}
</code></pre><p>}<br>```</p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><blockquote>
<p>haproxy是否动静分离</p>
</blockquote>
<p><img src="http://omsab2via.bkt.clouddn.com/h1.png" alt="enter image description here"></p>
<p><img src="http://omsab2via.bkt.clouddn.com/h2.png" alt="enter image description here"></p>
<p><img src="http://omsab2via.bkt.clouddn.com/h3.png" alt="enter image description here"></p>
<p><img src="http://omsab2via.bkt.clouddn.com/chrome.png" alt="enter image description here"><br>chrome浏览器会提示不安全的脚本</p>
<blockquote>
<p>验证keepalived</p>
<p>haproxy1：systemctl stop haproxy keepalived后ha2成功拿到ip</p>
</blockquote>
<p><img src="http://omsab2via.bkt.clouddn.com/1.png" alt="enter image description here"><img src="http://omsab2via.bkt.clouddn.com/2.png" alt="enter image description here"><br>web正常</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/05/18/web站点的动静分离及高可用/" data-id="cjb05oynm00219fzuk4zbbcqg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Haproxy/">Haproxy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Keepalived/">Keepalived</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-keepalived" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/15/keepalived/" class="article-date">
  <time datetime="2017-05-15T13:24:00.000Z" itemprop="datePublished">2017-05-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Keepalived/">Keepalived</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/15/keepalived/">keepalived双主模型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a><strong>Keepalived</strong></h4><ul>
<li>DR1</li>
</ul>
<pre><code>[root@71 keepalived]# cat  keepalived.conf 
! Configuration File for keepalived

global_defs {
   notification_email {
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
   vrrp_mcast_group4 224.0.0.50
}
vrrp_instance ip1 {
    state MASTER
    interface enp0s3
    virtual_router_id 50
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
         172.18.50.100/16 dev enp0s3
    }
}
vrrp_instance ip2 {
    state BACKUP
    interface enp0s3
    virtual_router_id 51
    priority 80
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 22222
    }
    virtual_ipaddress {
         172.18.50.200/16 dev enp0s3
    }
}
</code></pre><ul>
<li>DR2</li>
</ul>
<pre><code>[root@72 keepalived]# cat keepalived.conf 
! Configuration File for keepalived

global_defs {
   notification_email {
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
   vrrp_mcast_group4 224.0.0.50
}
vrrp_instance ip1 {
    state BACKUP
    interface enp0s3
    virtual_router_id 50
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
         172.18.50.100/16 dev enp0s3
    }
}
vrrp_instance ip2 {
    state MASTER
    interface enp0s3
    virtual_router_id 51
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 22222
    }
    virtual_ipaddress {
         172.18.50.200/16 dev enp0s3
    }
}
</code></pre><ul>
<li>示例通知脚本：</li>
</ul>
<pre><code>#!/bin/bash
#
contact=&#39;root@localhost&#39;

notify() {
    mailsubject=&quot;$(hostname) to be $1, vip floating&quot;
    mailbody=&quot;$(date +&#39;%F %T&#39;): vrrp transition, $(hostname) changed to be $1&quot;
    echo &quot;$mailbody&quot; | mail -s &quot;$mailsubject&quot; $contact
                }

case $1 in
master)
    notify master
    ;;
backup)
    notify backup
    ;;
fault)
    notify fault
    ;;
*)
    echo &quot;Usage: $(basename $0) {master|backup|fault}&quot;
    exit 1
    ;;
esac
</code></pre><ul>
<li>调用方法</li>
</ul>
<pre><code>notify_master &quot;/etc/keepalived/notify.sh master&quot;
notify_backup &quot;/etc/keepalived/notify.sh backup&quot;
notify_fault &quot;/etc/keepalived/notify.sh fault&quot;
</code></pre><ul>
<li>高可用ipvs配置示例</li>
</ul>
<pre><code>virtual_server 172.18.50.100 {
    delay_loop 3
    lb_algo rr
    lb_kind DR
    protocol TCP

    sorry_server 127.0.0.1 80

    real_server 10.1.0.69 80 {
        weight 1
        HTTP_GET {
        url {
            path /
            status_code 200
        }
        connect_timeout 1
        nb_get_retry 3
        delay_before_retry 1
        }
    }
    real_server 10.1.0.71 80 {
        weight 1
        HTTP_GET {
        url {
            path /
            status_code 200
        }
        connect_timeout 1
        nb_get_retry 3
        delay_before_retry 1
        }
    }
}
</code></pre><ul>
<li>参数详解</li>
</ul>
<pre><code>delay_loop &lt;INT&gt;：服务轮询的时间间隔；
lb_algo rr|wrr|lc|wlc|lblc|sh|dh：定义调度方法；
lb_kind NAT|DR|TUN：集群的类型；
persistence_timeout &lt;INT&gt;：持久连接时长；
protocol TCP：服务协议，仅支持TCP；
sorry_server &lt;IPADDR&gt; &lt;PORT&gt;：备用服务器地址；
real_server &lt;IPADDR&gt; &lt;PORT&gt;
{
     weight &lt;INT&gt;
     notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;
     notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;
     HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK { ... }：定义当前主机的健康状态检测方法；
}
HTTP_GET|SSL_GET：应用层检测

HTTP_GET|SSL_GET {
    url {
        path &lt;URL_PATH&gt;：定义要监控的URL；
        status_code &lt;INT&gt;：判断上述检测机制为健康状态的响应码；
        digest &lt;STRING&gt;：判断上述检测机制为健康状态的响应的内容的校验码；
    }
    nb_get_retry &lt;INT&gt;：重试次数；
    delay_before_retry &lt;INT&gt;：重试之前的延迟时长；
    connect_ip &lt;IP ADDRESS&gt;：向当前RS的哪个IP地址发起健康状态检测请求
    connect_port &lt;PORT&gt;：向当前RS的哪个PORT发起健康状态检测请求
    bindto &lt;IP ADDRESS&gt;：发出健康状态检测请求时使用的源地址；
    bind_port &lt;PORT&gt;：发出健康状态检测请求时使用的源端口；
    connect_timeout &lt;INTEGER&gt;：连接请求的超时时长；
}
 TCP_CHECK {
    connect_ip &lt;IP ADDRESS&gt;：向当前RS的哪个IP地址发起健康状态检测请求
    connect_port &lt;PORT&gt;：向当前RS的哪个PORT发起健康状态检测请求
    bindto &lt;IP ADDRESS&gt;：发出健康状态检测请求时使用的源地址；
    bind_port &lt;PORT&gt;：发出健康状态检测请求时使用的源端口；
    connect_timeout &lt;INTEGER&gt;：连接请求的超时时长；
}
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://shensir.info/2017/05/15/keepalived/" data-id="cjb05oyn9001d9fzursyv2nga" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/keepalived/">keepalived</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/负载均衡/">负载均衡</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/HTTP-HEADER/">HTTP HEADER</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Haproxy/">Haproxy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Keepalived/">Keepalived</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ca/">Ca</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fastdfs/">Fastdfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-HEADER/">HTTP HEADER</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haproxy/">Haproxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Httpd/">Httpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Https/">Https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iptables/">Iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/">Keepalived</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maradb/">Maradb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mariadb/">Mariadb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MogileFS/">MogileFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Notes/">Notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProxySQL/">ProxySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bind/">bind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/keepalived/">keepalived</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvs/">lvs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/modules/">modules</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nfs/">nfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/session/">session</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中间件/">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/主从复制/">主从复制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式文件系统/">分布式文件系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础命令/">基础命令</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件共享/">文件共享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负载均衡/">负载均衡</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Ca/" style="font-size: 10px;">Ca</a> <a href="/tags/Fastdfs/" style="font-size: 10px;">Fastdfs</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/HTTP-HEADER/" style="font-size: 10px;">HTTP HEADER</a> <a href="/tags/Haproxy/" style="font-size: 10px;">Haproxy</a> <a href="/tags/Http/" style="font-size: 13.33px;">Http</a> <a href="/tags/Httpd/" style="font-size: 10px;">Httpd</a> <a href="/tags/Https/" style="font-size: 13.33px;">Https</a> <a href="/tags/Iptables/" style="font-size: 10px;">Iptables</a> <a href="/tags/Keepalived/" style="font-size: 10px;">Keepalived</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/Maradb/" style="font-size: 10px;">Maradb</a> <a href="/tags/Mariadb/" style="font-size: 13.33px;">Mariadb</a> <a href="/tags/MogileFS/" style="font-size: 10px;">MogileFS</a> <a href="/tags/Notes/" style="font-size: 13.33px;">Notes</a> <a href="/tags/ProxySQL/" style="font-size: 10px;">ProxySQL</a> <a href="/tags/bind/" style="font-size: 10px;">bind</a> <a href="/tags/keepalived/" style="font-size: 13.33px;">keepalived</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/lvs/" style="font-size: 10px;">lvs</a> <a href="/tags/modules/" style="font-size: 10px;">modules</a> <a href="/tags/nfs/" style="font-size: 10px;">nfs</a> <a href="/tags/nginx/" style="font-size: 13.33px;">nginx</a> <a href="/tags/session/" style="font-size: 10px;">session</a> <a href="/tags/web/" style="font-size: 13.33px;">web</a> <a href="/tags/中间件/" style="font-size: 10px;">中间件</a> <a href="/tags/主从复制/" style="font-size: 10px;">主从复制</a> <a href="/tags/分布式文件系统/" style="font-size: 10px;">分布式文件系统</a> <a href="/tags/基础命令/" style="font-size: 10px;">基础命令</a> <a href="/tags/文件共享/" style="font-size: 10px;">文件共享</a> <a href="/tags/负载均衡/" style="font-size: 13.33px;">负载均衡</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/12/Fastdfs安装配置/">Fastdfs安装配置</a>
          </li>
        
          <li>
            <a href="/2017/06/12/Maradb主主复制/">Maradb主主复制</a>
          </li>
        
          <li>
            <a href="/2017/06/12/Mariadb半同步复制及复制过滤器/">Mariadb半同步复制及复制过滤器</a>
          </li>
        
          <li>
            <a href="/2017/06/12/MogileFS的安装配置/">MogileFS的安装配置</a>
          </li>
        
          <li>
            <a href="/2017/06/12/Maradb主从复制/">Maradb主从复制</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Pursuit<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>